<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP管理 - MAG SDK 使用文档</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #fafafa;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* 侧边栏样式 */
        .sidebar {
            width: 280px;
            background: #fff;
            border-right: 1px solid #e1e5e9;
            padding: 20px 0;
            overflow-y: auto;
            position: fixed;
            height: 100vh;
            z-index: 1000;
        }

        .logo {
            padding: 0 20px 20px;
            border-bottom: 1px solid #e1e5e9;
            margin-bottom: 20px;
        }

        .logo h1 {
            color: #2563eb;
            font-size: 24px;
            font-weight: 700;
        }

        .logo p {
            color: #6b7280;
            font-size: 14px;
            margin-top: 5px;
        }

        .nav {
            list-style: none;
        }

        .nav-item {
            margin-bottom: 5px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 10px 20px;
            color: #4b5563;
            text-decoration: none;
            transition: all 0.2s;
            border-right: 3px solid transparent;
        }

        .nav-link:hover {
            background-color: #f3f4f6;
            color: #2563eb;
        }

        .nav-link.active {
            background-color: #eff6ff;
            color: #2563eb;
            border-right-color: #2563eb;
        }

        .nav-link i {
            margin-right: 10px;
            width: 16px;
        }

        /* 折叠菜单样式 */
        .nav-group {
            margin-bottom: 10px;
        }

        .nav-group-title {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 20px;
            color: #374151;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .nav-group-title:hover {
            background-color: #f9fafb;
            color: #2563eb;
        }

        .nav-group-title.active {
            background-color: #eff6ff;
            color: #2563eb;
        }

        .nav-group-content {
            max-height: 500px;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .nav-group-content .nav-link {
            padding-left: 50px;
            font-size: 14px;
        }

        .chevron {
            transition: transform 0.3s ease;
            transform: rotate(90deg);
        }

        /* 主内容区域 */
        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 40px 60px;
            background: #fff;
            min-height: 100vh;
        }

        /* 页面头部 */
        .page-header {
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e5e7eb;
        }

        .page-header h1 {
            color: #1f2937;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .page-header p {
            color: #6b7280;
            font-size: 1.1rem;
        }

        /* 内容区块 */
        .section {
            margin-bottom: 50px;
        }

        .section h2 {
            color: #1f2937;
            font-size: 1.8rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section h3 {
            color: #374151;
            font-size: 1.3rem;
            margin: 30px 0 15px;
        }

        .section p {
            color: #6b7280;
            line-height: 1.8;
            margin-bottom: 20px;
        }

        /* 代码块样式 */
        .code-block {
            background: #1a1a1a;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            position: relative;
            overflow-x: auto;
        }

        .code-block pre {
            margin: 0;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
            line-height: 1.5;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .copy-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #4b5563;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.2s;
        }

        .copy-btn:hover {
            background: #6b7280;
        }

        /* 功能卡片 */
        .function-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 30px;
            margin: 30px 0;
            transition: all 0.3s ease;
        }

        .function-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .function-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .function-icon {
            background: #2563eb;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 1.5rem;
        }

        .function-title {
            color: #1f2937;
            font-size: 1.4rem;
            font-weight: 600;
        }

        /* 参数表格 */
        .param-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .param-table th,
        .param-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        .param-table th {
            background: #f9fafb;
            font-weight: 600;
            color: #374151;
        }

        .param-table tr:last-child td {
            border-bottom: none;
        }

        /* 返回值样式 */
        .return-value {
            background: #ecfdf5;
            border: 1px solid #a7f3d0;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }

        .return-value h4 {
            color: #065f46;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .return-value p {
            color: #047857;
            margin: 0;
        }

        /* 注意事项 */
        .note {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }

        .note h4 {
            color: #92400e;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .note p {
            color: #b45309;
            margin: 0;
        }

        /* 目录导航 */
        .toc {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .toc h3 {
            color: #374151;
            margin-bottom: 15px;
        }

        .toc ul {
            list-style: none;
            padding: 0;
        }

        .toc li {
            margin: 8px 0;
        }

        .toc a {
            color: #2563eb;
            text-decoration: none;
            padding: 5px 10px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .toc a:hover {
            background: #eff6ff;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }

            .main-content {
                margin-left: 0;
                padding: 20px;
            }

            .page-header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 侧边栏 -->
        <nav class="sidebar">
            <div class="logo">
                <h1><i class="fas fa-project-diagram"></i> MAG SDK</h1>
                <p>MCP Agent Graph 开发框架</p>
            </div>
            
            <ul class="nav">
                <li class="nav-item">
                    <a href="index.html" class="nav-link">
                        <i class="fas fa-home"></i>
                        概述
                    </a>
                </li>
                
                <li class="nav-group">
                    <div class="nav-group-title">
                        <span><i class="fas fa-cog"></i> 系统管理</span>
                        <i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="nav-group-content" style="max-height: 0;">
                        <a href="system.html#system-start" class="nav-link">
                            <i class="fas fa-play"></i>
                            启动服务
                        </a>
                        <a href="system.html#system-status" class="nav-link">
                            <i class="fas fa-info-circle"></i>
                            状态检查
                        </a>
                        <a href="system.html#system-shutdown" class="nav-link">
                            <i class="fas fa-stop"></i>
                            关闭服务
                        </a>
                    </div>
                </li>

                <li class="nav-group">
                    <div class="nav-group-title">
                        <span><i class="fas fa-project-diagram"></i> 图管理</span>
                        <i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="nav-group-content" style="max-height: 0;">
                        <a href="graph.html#graph-list" class="nav-link">列出图</a>
                        <a href="graph.html#graph-get" class="nav-link">获取图</a>
                        <a href="graph.html#graph-save" class="nav-link">保存图</a>
                        <a href="graph.html#graph-delete" class="nav-link">删除图</a>
                        <a href="graph.html#graph-run" class="nav-link">运行图</a>
                        <a href="graph.html#graph-import" class="nav-link">导入图</a>
                        <a href="graph.html#graph-export" class="nav-link">导出图</a>
                        <a href="graph.html#graph-mcp" class="nav-link">生成MCP脚本</a>
                    </div>
                </li>

                <li class="nav-group">
                    <div class="nav-group-title">
                        <span><i class="fas fa-brain"></i> 模型管理</span>
                        <i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="nav-group-content" style="max-height: 0;">
                        <a href="model.html#model-list" class="nav-link">列出模型</a>
                        <a href="model.html#model-add" class="nav-link">添加模型</a>
                        <a href="model.html#model-update" class="nav-link">更新模型</a>
                        <a href="model.html#model-delete" class="nav-link">删除模型</a>
                    </div>
                </li>

                <li class="nav-group">
                    <div class="nav-group-title active">
                        <span><i class="fas fa-server"></i> MCP管理</span>
                        <i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="nav-group-content">
                        <a href="#mcp-config" class="nav-link active">配置管理</a>
                        <a href="#mcp-status" class="nav-link">状态查看</a>
                        <a href="#mcp-connect" class="nav-link">连接服务器</a>
                        <a href="#mcp-tools" class="nav-link">工具管理</a>
                        <a href="#mcp-servers" class="nav-link">服务器管理</a>
                    </div>
                </li>

                <li class="nav-group">
                    <div class="nav-group-title">
                        <span><i class="fas fa-comments"></i> 会话管理</span>
                        <i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="nav-group-content" style="max-height: 0;">
                        <a href="conversation.html#conversation-list" class="nav-link">列出会话</a>
                        <a href="conversation.html#conversation-get" class="nav-link">获取会话</a>
                        <a href="conversation.html#conversation-delete" class="nav-link">删除会话</a>
                    </div>
                </li>

                <li class="nav-item">
                    <a href="examples.html" class="nav-link">
                        <i class="fas fa-code"></i>
                        示例教程
                    </a>
                </li>
            </ul>
        </nav>

        <!-- 主内容区域 -->
        <main class="main-content">
            <div class="page-header">
                <h1><i class="fas fa-server"></i> MCP管理</h1>
                <p>MCP服务器的配置、连接和工具管理</p>
            </div>

            <!-- 目录导航 -->
            <div class="toc">
                <h3><i class="fas fa-list"></i> 本页内容</h3>
                <ul>
                    <li><a href="#mcp-config">配置管理 - 获取和更新MCP配置</a></li>
                    <li><a href="#mcp-status">状态查看 - mag.get_mcp_status()</a></li>
                    <li><a href="#mcp-connect">连接服务器 - mag.connect_mcp()</a></li>
                    <li><a href="#mcp-tools">工具管理 - mag.get_tools()</a></li>
                    <li><a href="#mcp-servers">服务器管理 - 添加和删除服务器</a></li>
                </ul>
            </div>

            <!-- 配置管理 -->
            <section class="section" id="mcp-config">
                <div class="function-card">
                    <div class="function-header">
                        <div class="function-icon">
                            <i class="fas fa-cogs"></i>
                        </div>
                        <div class="function-title">MCP配置管理</div>
                    </div>
                    
                    <p>MCP配置管理包括获取当前配置和更新配置两个主要功能。</p>

                    <h3>获取MCP配置 - mag.get_mcp_config()</h3>
                    <div class="code-block">
                        <button class="copy-btn" onclick="copyCode(this)">复制</button>
                        <pre><code class="language-python">def get_mcp_config() -> Dict[str, Any]:
    """
    获取MCP配置
    
    返回:
        Dict[str, Any]: MCP配置
    """</code></pre>
                    </div>

                    <h3>更新MCP配置 - mag.update_mcp_config()</h3>
                    <div class="code-block">
                        <button class="copy-btn" onclick="copyCode(this)">复制</button>
                        <pre><code class="language-python">def update_mcp_config(config: Dict[str, Any]) -> Dict[str, Dict[str, Any]]:
    """
    更新MCP配置
    
    参数:
        config (Dict[str, Any]): MCP配置
    
    返回:
        Dict[str, Dict[str, Any]]: 操作结果
    """</code></pre>
                    </div>

                    <h3>使用示例</h3>
                    <div class="code-block">
                        <button class="copy-btn" onclick="copyCode(this)">复制</button>
                        <pre><code class="language-python">import mag
import json

# 获取当前MCP配置
current_config = mag.get_mcp_config()
print("当前MCP配置:")
print(json.dumps(current_config, indent=2, ensure_ascii=False))

# 更新MCP配置（完整替换）
new_config = {
    "mcpServers": {
        "fetch": {
            "autoApprove": ["fetch"],
            "timeout": 60,
            "command": "uvx",
            "args": ["mcp-server-fetch"],
            "transportType": "stdio"
        },
        "memory": {
            "autoApprove": [],
            "timeout": 60,
            "command": "docker",
            "args": [
                "run", "-i", "-v", 
                "claude-memory:/app/dist",
                "--rm", "mcp/memory"
            ],
            "transportType": "stdio"
        },
        "tavily-mcp": {
            "command": "npx",
            "args": ["-y", "tavily-mcp@0.1.2"],
            "env": {
                "TAVILY_API_KEY": "tvly-dev-your-api-key"
            }
        }
    }
}

# 执行配置更新
result = mag.update_mcp_config(new_config)
print("\n配置更新结果:")
print(json.dumps(result, indent=2, ensure_ascii=False))
</code></pre>
                    </div>

                    <div class="note">
                        <h4><i class="fas fa-exclamation-triangle"></i> 配置更新注意事项</h4>
                        <p>• update_mcp_config() 会完全替换现有配置<br>
                        • 更新配置后会自动尝试重新连接所有服务器<br>
                        • 建议在更新前备份当前配置<br>
                        • 环境变量中的敏感信息（如API密钥）需要正确设置</p>
                    </div>
                </div>
            </section>

            <!-- 状态查看 -->
            <section class="section" id="mcp-status">
                <div class="function-card">
                    <div class="function-header">
                        <div class="function-icon">
                            <i class="fas fa-info-circle"></i>
                        </div>
                        <div class="function-title">mag.get_mcp_status()</div>
                    </div>
                    
                    <p>获取所有MCP服务器的当前连接状态和可用工具信息。</p>

                    <h3>函数签名</h3>
                    <div class="code-block">
                        <button class="copy-btn" onclick="copyCode(this)">复制</button>
                        <pre><code class="language-python">def get_mcp_status() -> Dict[str, Dict[str, Any]]:
    """
    获取MCP服务器状态
    
    返回:
        Dict[str, Dict[str, Any]]: 服务器状态字典
    """</code></pre>
                    </div>

                    <h3>返回值</h3>
                    <div class="return-value">
                        <h4><i class="fas fa-check-circle"></i> 返回值说明</h4>
                        <p><strong>Dict[str, Dict[str, Any]]</strong> - 服务器状态字典，每个服务器包含connected、tools等状态信息</p>
                    </div>

                    <h3>使用示例</h3>
                    <div class="code-block">
                        <button class="copy-btn" onclick="copyCode(this)">复制</button>
                        <pre><code class="language-python">import mag

# 获取MCP服务器状态
status = mag.get_mcp_status()

print("MCP服务器状态总览:")
print(f"配置的服务器数量: {len(status)}")

# 统计连接状态
connected_count = 0
total_tools = 0

for server_name, server_status in status.items():
    is_connected = server_status.get('connected', False)
    tools_count = len(server_status.get('tools', []))
    
    print(f"\n📡 {server_name}")
    print(f"   状态: {'🟢 已连接' if is_connected else '🔴 未连接'}")
    print(f"   工具数量: {tools_count}")
    
    if is_connected:
        connected_count += 1
        total_tools += tools_count
        
        # 显示工具列表
        if tools_count > 0:
            print("   可用工具:")
            for tool in server_status.get('tools', []):
                print(f"     • {tool}")

print(f"\n📊 状态汇总:")
print(f"   已连接: {connected_count}/{len(status)} 个服务器")
print(f"   总工具数: {total_tools} 个")
</code></pre>
                    </div>

                    <h3>状态监控和告警</h3>
                    <div class="code-block">
                        <button class="copy-btn" onclick="copyCode(this)">复制</button>
                        <pre><code class="language-python">def monitor_mcp_health():
                    """监控MCP服务器健康状态"""
                    status = mag.get_mcp_status()
                    
                    issues = []
                    for server_name, server_status in status.items():
                        if not server_status.get('connected', False):
                            issues.append(f"服务器 '{server_name}' 未连接")
                        elif len(server_status.get('tools', [])) == 0:
                            issues.append(f"服务器 '{server_name}' 已连接但无可用工具")
                    
                    if issues:
                        print("⚠️  发现以下问题:")
                        for issue in issues:
                            print(f"   • {issue}")
                        return False
                    else:
                        print("✅ 所有MCP服务器运行正常")
                        return True

# 健康检查
is_healthy = monitor_mcp_health()

# 详细状态报告
def generate_status_report():
    """生成详细的状态报告"""
    status = mag.get_mcp_status()
    
    report = []
    report.append("# MCP服务器状态报告")
    report.append(f"生成时间: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    report.append("")
    
    for server_name, server_status in status.items():
        report.append(f"## {server_name}")
        report.append(f"- 连接状态: {'已连接' if server_status.get('connected') else '未连接'}")
        report.append(f"- 工具数量: {len(server_status.get('tools', []))}")
        
        if server_status.get('tools'):
            report.append("- 可用工具:")
            for tool in server_status.get('tools', []):
                report.append(f"  - {tool}")
        
        report.append("")
    
    return "\n".join(report)

# 生成并保存报告
report = generate_status_report()
with open("mcp_status_report.md", "w", encoding="utf-8") as f:
    f.write(report)
print("状态报告已保存到: mcp_status_report.md")
</code></pre>
                    </div>
                </div>
            </section>

            <!-- 连接服务器 -->
            <section class="section" id="mcp-connect">
                <div class="function-card">
                    <div class="function-header">
                        <div class="function-icon">
                            <i class="fas fa-plug"></i>
                        </div>
                        <div class="function-title">mag.connect_mcp()</div>
                    </div>
                    
                    <p>连接指定的MCP服务器或连接所有配置的服务器。</p>

                    <h3>函数签名</h3>
                    <div class="code-block">
                        <button class="copy-btn" onclick="copyCode(this)">复制</button>
                        <pre><code class="language-python">def connect_mcp(server_name: str) -> Dict[str, Any]:
    """
    连接指定的MCP服务器
    
    参数:
        server_name (str): 服务器名称，使用 "all" 连接所有服务器
    
    返回:
        Dict[str, Any]: 连接结果
    """</code></pre>
                    </div>

                    <h3>使用示例</h3>
                    <div class="code-block">
                        <button class="copy-btn" onclick="copyCode(this)">复制</button>
                        <pre><code class="language-python">import mag

# 连接单个服务器
result = mag.connect_mcp("tavily-mcp")
print(f"连接tavily-mcp结果: {result}")

# 连接所有服务器
all_result = mag.connect_mcp("all")
print("连接所有服务器结果:")
print(json.dumps(all_result, indent=2, ensure_ascii=False))

# 智能连接：只连接未连接的服务器
def smart_connect_all():
    """智能连接：只连接未连接的服务器"""
    # 先获取状态
    status = mag.get_mcp_status()
    
    disconnected_servers = []
    for server_name, server_status in status.items():
        if not server_status.get('connected', False):
            disconnected_servers.append(server_name)
    
    if not disconnected_servers:
        print("✅ 所有服务器都已连接")
        return True
    
    print(f"发现 {len(disconnected_servers)} 个未连接的服务器:")
    for server in disconnected_servers:
        print(f"  • {server}")
    
    # 尝试连接未连接的服务器
    success_count = 0
    for server_name in disconnected_servers:
        try:
            result = mag.connect_mcp(server_name)
            if result.get('status') == 'success':
                print(f"✅ {server_name} 连接成功")
                success_count += 1
            else:
                print(f"❌ {server_name} 连接失败: {result.get('error', 'Unknown error')}")
        except Exception as e:
            print(f"❌ {server_name} 连接出错: {e}")
    
    print(f"\n连接完成: {success_count}/{len(disconnected_servers)} 个服务器成功连接")
    return success_count == len(disconnected_servers)

# 使用智能连接
smart_connect_all()
</code></pre>
                    </div>

                    <h3>连接重试机制</h3>
                    <div class="code-block">
                        <button class="copy-btn" onclick="copyCode(this)">复制</button>
                        <pre><code class="language-python">import time

def connect_with_retry(server_name, max_retries=3, delay=2):
    """带重试机制的连接函数"""
    for attempt in range(max_retries):
        try:
            print(f"尝试连接 {server_name} (第 {attempt + 1}/{max_retries} 次)...")
            result = mag.connect_mcp(server_name)
            
            if result.get('status') == 'success':
                print(f"✅ {server_name} 连接成功!")
                return True
            else:
                error_msg = result.get('error', 'Unknown error')
                print(f"❌ 连接失败: {error_msg}")
                
                if attempt < max_retries - 1:
                    print(f"等待 {delay} 秒后重试...")
                    time.sleep(delay)
        
        except Exception as e:
            print(f"❌ 连接出错: {e}")
            if attempt < max_retries - 1:
                print(f"等待 {delay} 秒后重试...")
                time.sleep(delay)
    
    print(f"❌ {server_name} 连接失败，已达到最大重试次数")
    return False

# 使用重试连接
success = connect_with_retry("problematic-server", max_retries=3, delay=2)
</code></pre>
                    </div>
                </div>
            </section>

            <!-- 工具管理 -->
            <section class="section" id="mcp-tools">
                <div class="function-card">
                    <div class="function-header">
                        <div class="function-icon">
                            <i class="fas fa-tools"></i>
                        </div>
                        <div class="function-title">mag.get_tools()</div>
                    </div>
                    
                    <p>获取所有MCP服务器提供的工具详细信息，包括工具名称、描述、参数等。</p>

                    <h3>函数签名</h3>
                    <div class="code-block">
                        <button class="copy-btn" onclick="copyCode(this)">复制</button>
                        <pre><code class="language-python">def get_tools() -> Dict[str, List[Dict[str, Any]]]:
    """
    获取所有MCP工具信息
    
    返回:
        Dict[str, List[Dict[str, Any]]]: 按服务器分组的工具信息
    """</code></pre>
                    </div>

                    <h3>返回值</h3>
                    <div class="return-value">
                        <h4><i class="fas fa-check-circle"></i> 返回值说明</h4>
                        <p><strong>Dict[str, List[Dict[str, Any]]]</strong> - 按服务器分组的工具信息，每个工具包含name、description等详细信息</p>
                    </div>

                    <h3>使用示例</h3>
                    <div class="code-block">
                        <button class="copy-btn" onclick="copyCode(this)">复制</button>
                        <pre><code class="language-python">import mag
import json

# 获取所有工具信息
tools_info = mag.get_tools()

print("MCP工具信息:")
print(f"共有 {len(tools_info)} 个服务提供工具")

total_tools = 0
for server_name, tools in tools_info.items():
    total_tools += len(tools)
    print(f"\n🔧 {server_name} ({len(tools)} 个工具):")
    
    for i, tool in enumerate(tools, 1):
        print(f"   {i}. {tool.get('name', 'Unknown')}")
        print(f"      描述: {tool.get('description', '无描述')}")
        
        # 显示工具参数（如果有）
        if 'inputSchema' in tool:
            schema = tool['inputSchema']
            if 'properties' in schema:
                print(f"      参数: {list(schema['properties'].keys())}")

print(f"\n📊 总计: {total_tools} 个工具")

# 详细工具信息展示
def display_tool_details(server_name=None, tool_name=None):
    """显示工具的详细信息"""
    tools_info = mag.get_tools()
    
    for srv_name, tools in tools_info.items():
        # 如果指定了服务器名称，只显示该服务器的工具
        if server_name and srv_name != server_name:
            continue
            
        for tool in tools:
            # 如果指定了工具名称，只显示该工具
            if tool_name and tool.get('name') != tool_name:
                continue
                
            print(f"\n🔧 工具: {tool.get('name', 'Unknown')}")
            print(f"   服务器: {srv_name}")
            print(f"   描述: {tool.get('description', '无描述')}")
            
            # 显示详细的参数信息
            if 'inputSchema' in tool:
                schema = tool['inputSchema']
                print("   参数详情:")
                print(json.dumps(schema, indent=6, ensure_ascii=False))

# 显示特定服务器的工具
display_tool_details(server_name="tavily-mcp")

# 显示特定工具的详情
display_tool_details(tool_name="search")
</code></pre>
                    </div>

                    <h3>工具分类和搜索</h3>
                    <div class="code-block">
                        <button class="copy-btn" onclick="copyCode(this)">复制</button>
                        <pre><code class="language-python">def categorize_tools():
    """将工具按功能分类"""
    tools_info = mag.get_tools()
    
    categories = {
        "搜索工具": [],
        "文件操作": [],
        "数据处理": [],
        "网络请求": [],
        "其他": []
    }
    
    # 根据工具名称和描述进行分类
    for server_name, tools in tools_info.items():
        for tool in tools:
            tool_name = tool.get('name', '').lower()
            tool_desc = tool.get('description', '').lower()
            
            tool_info = {
                'name': tool.get('name'),
                'server': server_name,
                'description': tool.get('description', '无描述')
            }
            
            if any(keyword in tool_name or keyword in tool_desc 
                   for keyword in ['search', 'find', '搜索', '查找']):
                categories["搜索工具"].append(tool_info)
            elif any(keyword in tool_name or keyword in tool_desc 
                     for keyword in ['file', 'read', 'write', '文件', '读取', '写入']):
                categories["文件操作"].append(tool_info)
            elif any(keyword in tool_name or keyword in tool_desc 
                     for keyword in ['data', 'process', 'analysis', '数据', '处理', '分析']):
                categories["数据处理"].append(tool_info)
            elif any(keyword in tool_name or keyword in tool_desc 
                     for keyword in ['fetch', 'request', 'http', 'api', '请求']):
                categories["网络请求"].append(tool_info)
            else:
                categories["其他"].append(tool_info)
    
    # 显示分类结果
    for category, tools in categories.items():
        if tools:
            print(f"\n📂 {category} ({len(tools)} 个):")
            for tool in tools:
                print(f"   • {tool['name']} ({tool['server']})")
                print(f"     {tool['description']}")

# 工具分类展示
categorize_tools()

def search_tools(keyword):
    """搜索包含关键词的工具"""
    tools_info = mag.get_tools()
    matching_tools = []
    
    for server_name, tools in tools_info.items():
        for tool in tools:
            tool_name = tool.get('name', '').lower()
            tool_desc = tool.get('description', '').lower()
            
            if keyword.lower() in tool_name or keyword.lower() in tool_desc:
                matching_tools.append({
                    'name': tool.get('name'),
                    'server': server_name,
                    'description': tool.get('description', '无描述')
                })
    
    if matching_tools:
        print(f"\n🔍 搜索 '{keyword}' 找到 {len(matching_tools)} 个工具:")
        for tool in matching_tools:
            print(f"   • {tool['name']} ({tool['server']})")
            print(f"     {tool['description']}")
    else:
        print(f"未找到包含 '{keyword}' 的工具")
    
    return matching_tools

# 搜索工具
search_results = search_tools("search")
</code></pre>
                    </div>
                </div>
            </section>

            <!-- 服务器管理 -->
            <section class="section" id="mcp-servers">
                <div class="function-card">
                    <div class="function-header">
                        <div class="function-icon">
                            <i class="fas fa-server"></i>
                        </div>
                        <div class="function-title">MCP服务器管理</div>
                    </div>
                    
                    <p>MCP服务器的添加和删除管理功能。</p>

                    <h3>添加服务器 - mag.add_server()</h3>
                    <div class="code-block">
                        <button class="copy-btn" onclick="copyCode(this)">复制</button>
                        <pre><code class="language-python">def add_server(servers: Dict[str, Any]) -> Dict[str, Any]:
    """
    添加新的MCP服务器配置
    
    参数:
        servers (Dict[str, Any]): 包含mcpServers的完整配置
    
    返回:
        Dict[str, Any]: 添加结果
    """</code></pre>
                    </div>

                    <h3>删除服务器 - mag.remove_server()</h3>
                    <div class="code-block">
                        <button class="copy-btn" onclick="copyCode(this)">复制</button>
                        <pre><code class="language-python">def remove_server(names: Union[str, List[str]]) -> Dict[str, Any]:
    """
    删除MCP服务器配置（支持单个或批量删除）
    
    参数:
        names (Union[str, List[str]]): 服务器名称或服务器名称列表
    
    返回:
        Dict[str, Any]: 删除结果
    """</code></pre>
                    </div>

                    <h3>使用示例</h3>
                    <div class="code-block">
                        <button class="copy-btn" onclick="copyCode(this)">复制</button>
                        <pre><code class="language-python">import mag
import json

# 添加新的MCP服务器
new_servers = {
    "mcpServers": {
        "fetch": {
            "autoApprove": ["fetch"],
            "timeout": 60,
            "command": "uvx",
            "args": ["mcp-server-fetch"],
            "transportType": "stdio"
        },
        "memory": {
            "autoApprove": [],
            "timeout": 60,
            "command": "docker",
            "args": [
                "run", "-i", "-v",
                "claude-memory:/app/dist",
                "--rm", "mcp/memory"
            ],
            "transportType": "stdio"
        }
    }
}

# 执行添加操作
add_result = mag.add_server(new_servers)
print("添加服务器结果:")
print(json.dumps(add_result, indent=2, ensure_ascii=False))

# 处理添加结果
if add_result['status'] == 'success':
    print(f"✅ 成功添加 {len(add_result['added_servers'])} 个服务器")
    for server in add_result['added_servers']:
        print(f"   • {server}")
        
    if add_result['duplicate_servers']:
        print(f"⚠️  跳过 {len(add_result['duplicate_servers'])} 个重复服务器")
        for server in add_result['duplicate_servers']:
            print(f"   • {server}")

# 删除服务器（单个）
remove_result = mag.remove_server("old-server")
print(f"删除单个服务器结果: {remove_result}")

# 批量删除服务器
servers_to_remove = ["test-server-1", "test-server-2"]
batch_remove_result = mag.remove_server(servers_to_remove)
print("批量删除结果:")
print(json.dumps(batch_remove_result, indent=2, ensure_ascii=False))
</code></pre>
                    </div>

                    <h3>服务器配置模板</h3>
                    <div class="code-block">
                        <button class="copy-btn" onclick="copyCode(this)">复制</button>
                        <pre><code class="language-python"># 常用MCP服务器配置模板

# Fetch服务器（网络请求）
fetch_server = {
    "mcpServers": {
        "fetch": {
            "autoApprove": ["fetch"],
            "timeout": 60,
            "command": "uvx",
            "args": ["mcp-server-fetch"],
            "transportType": "stdio"
        }
    }
}

# Memory服务器（记忆功能）
memory_server = {
    "mcpServers": {
        "memory": {
            "autoApprove": [],
            "timeout": 60,
            "command": "docker",
            "args": [
                "run", "-i", "-v",
                "claude-memory:/app/dist",
                "--rm", "mcp/memory"
            ],
            "transportType": "stdio"
        }
    }
}

# Tavily搜索服务器
tavily_server = {
    "mcpServers": {
        "tavily-mcp": {
            "command": "npx",
            "args": ["-y", "tavily-mcp@0.1.2"],
            "env": {
                "TAVILY_API_KEY": "your-tavily-api-key"
            }
        }
    }
}

# 顺序思考服务器
sequential_thinking_server = {
    "mcpServers": {
        "sequentialthinking": {
            "command": "docker",
            "args": [
                "run", "--rm", "-i",
                "mcp/sequentialthinking"
            ]
        }
    }
}

# 批量添加多个服务器
def setup_common_servers():
    """设置常用的MCP服务器"""
    servers_to_add = [
        ("Fetch服务器", fetch_server),
        ("Memory服务器", memory_server),
        ("Tavily搜索", tavily_server),
        ("顺序思考", sequential_thinking_server)
    ]
    
    for name, config in servers_to_add:
        print(f"添加 {name}...")
        result = mag.add_server(config)
        
        if result['status'] == 'success':
            print(f"✅ {name} 添加成功")
        elif result['status'] == 'partial_success':
            print(f"⚠️  {name} 部分成功")
        else:
            print(f"❌ {name} 添加失败: {result.get('message', 'Unknown error')}")

# 执行批量设置
setup_common_servers()
</code></pre>
                    </div>

                    <h3>服务器管理最佳实践</h3>
                    <div class="code-block">
                        <button class="copy-btn" onclick="copyCode(this)">复制</button>
                        <pre><code class="language-python">def backup_mcp_config():
    """备份当前MCP配置"""
    config = mag.get_mcp_config()
    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    backup_file = f"mcp_config_backup_{timestamp}.json"
    
    with open(backup_file, 'w', encoding='utf-8') as f:
        json.dump(config, f, indent=2, ensure_ascii=False)
    
    print(f"✅ MCP配置已备份到: {backup_file}")
    return backup_file

def validate_server_config(server_config):
    """验证服务器配置的有效性"""
    required_fields = ['command']
    errors = []
    
    for server_name, config in server_config.get('mcpServers', {}).items():
        if not isinstance(config, dict):
            errors.append(f"服务器 '{server_name}' 的配置必须是字典类型")
            continue
            
        for field in required_fields:
            if field not in config:
                errors.append(f"服务器 '{server_name}' 缺少必需字段: {field}")
        
        # 检查环境变量配置
        if 'env' in config:
            for env_key, env_value in config['env'].items():
                if not env_value or env_value.startswith('your-'):
                    errors.append(f"服务器 '{server_name}' 的环境变量 '{env_key}' 需要设置实际值")
    
    return errors

def safe_add_server(server_config):
    """安全地添加服务器（包含验证和备份）"""
    # 备份当前配置
    backup_file = backup_mcp_config()
    
    # 验证配置
    errors = validate_server_config(server_config)
    if errors:
        print("❌ 配置验证失败:")
        for error in errors:
            print(f"   • {error}")
        return False
    
    # 添加服务器
    try:
        result = mag.add_server(server_config)
        if result['status'] in ['success', 'partial_success']:
            print("✅ 服务器添加成功")
            return True
        else:
            print(f"❌ 添加失败: {result.get('message', 'Unknown error')}")
            return False
    except Exception as e:
        print(f"❌ 添加过程中出错: {e}")
        return False

# 使用安全添加
new_server = {
    "mcpServers": {
        "test-server": {
            "command": "echo",
            "args": ["test"]
        }
    }
}

safe_add_server(new_server)
</code></pre>
                    </div>

                    <div class="note">
                        <h4><i class="fas fa-exclamation-triangle"></i> 服务器管理注意事项</h4>
                        <p>• 添加服务器前建议备份当前配置<br>
                        • 确保必要的环境变量已正确设置<br>
                        • 删除服务器会同时断开其连接<br>
                        • 服务器名称必须唯一<br>
                        • 修改配置后需要重新连接才能生效</p>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script>
        // 复制代码功能
        function copyCode(button) {
            const code = button.nextElementSibling.textContent;
            navigator.clipboard.writeText(code).then(() => {
                const originalText = button.textContent;
                button.textContent = '已复制!';
                button.style.background = '#10b981';
                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.background = '#4b5563';
                }, 2000);
            });
        }

        // 导航链接点击处理
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                // 移除其他活动状态
                document.querySelectorAll('.nav-link.active').forEach(el => {
                    el.classList.remove('active');
                });
                // 添加活动状态到当前链接
                e.target.classList.add('active');
            });
        });

        // 页面内锚点滚动
        document.querySelectorAll('a[href^="#"]').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const target = document.querySelector(link.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({ behavior: 'smooth' });
                }
            });
        });

        // 代码高亮
        Prism.highlightAll();
    </script>
</body>
</html>