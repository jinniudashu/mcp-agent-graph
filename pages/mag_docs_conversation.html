<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>会话管理 - MAG SDK 使用文档</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #fafafa;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* 侧边栏样式 */
        .sidebar {
            width: 280px;
            background: #fff;
            border-right: 1px solid #e1e5e9;
            padding: 20px 0;
            overflow-y: auto;
            position: fixed;
            height: 100vh;
            z-index: 1000;
        }

        .logo {
            padding: 0 20px 20px;
            border-bottom: 1px solid #e1e5e9;
            margin-bottom: 20px;
        }

        .logo h1 {
            color: #2563eb;
            font-size: 24px;
            font-weight: 700;
        }

        .logo p {
            color: #6b7280;
            font-size: 14px;
            margin-top: 5px;
        }

        .nav {
            list-style: none;
        }

        .nav-item {
            margin-bottom: 5px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 10px 20px;
            color: #4b5563;
            text-decoration: none;
            transition: all 0.2s;
            border-right: 3px solid transparent;
        }

        .nav-link:hover {
            background-color: #f3f4f6;
            color: #2563eb;
        }

        .nav-link.active {
            background-color: #eff6ff;
            color: #2563eb;
            border-right-color: #2563eb;
        }

        .nav-link i {
            margin-right: 10px;
            width: 16px;
        }

        /* 折叠菜单样式 */
        .nav-group {
            margin-bottom: 10px;
        }

        .nav-group-title {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 20px;
            color: #374151;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .nav-group-title:hover {
            background-color: #f9fafb;
            color: #2563eb;
        }

        .nav-group-title.active {
            background-color: #eff6ff;
            color: #2563eb;
        }

        .nav-group-content {
            max-height: 500px;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .nav-group-content .nav-link {
            padding-left: 50px;
            font-size: 14px;
        }

        .chevron {
            transition: transform 0.3s ease;
            transform: rotate(90deg);
        }

        /* 主内容区域 */
        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 40px 60px;
            background: #fff;
            min-height: 100vh;
        }

        /* 页面头部 */
        .page-header {
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e5e7eb;
        }

        .page-header h1 {
            color: #1f2937;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .page-header p {
            color: #6b7280;
            font-size: 1.1rem;
        }

        /* 内容区块 */
        .section {
            margin-bottom: 50px;
        }

        .section h2 {
            color: #1f2937;
            font-size: 1.8rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section h3 {
            color: #374151;
            font-size: 1.3rem;
            margin: 30px 0 15px;
        }

        .section p {
            color: #6b7280;
            line-height: 1.8;
            margin-bottom: 20px;
        }

        /* 代码块样式 */
        .code-block {
            background: #1a1a1a;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            position: relative;
            overflow-x: auto;
        }

        .code-block pre {
            margin: 0;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
            line-height: 1.5;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .copy-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #4b5563;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.2s;
        }

        .copy-btn:hover {
            background: #6b7280;
        }

        /* 功能卡片 */
        .function-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 30px;
            margin: 30px 0;
            transition: all 0.3s ease;
        }

        .function-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .function-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .function-icon {
            background: #2563eb;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 1.5rem;
        }

        .function-title {
            color: #1f2937;
            font-size: 1.4rem;
            font-weight: 600;
        }

        /* 参数表格 */
        .param-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .param-table th,
        .param-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        .param-table th {
            background: #f9fafb;
            font-weight: 600;
            color: #374151;
        }

        .param-table tr:last-child td {
            border-bottom: none;
        }

        /* 返回值样式 */
        .return-value {
            background: #ecfdf5;
            border: 1px solid #a7f3d0;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }

        .return-value h4 {
            color: #065f46;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .return-value p {
            color: #047857;
            margin: 0;
        }

        /* 注意事项 */
        .note {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }

        .note h4 {
            color: #92400e;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .note p {
            color: #b45309;
            margin: 0;
        }

        /* 目录导航 */
        .toc {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .toc h3 {
            color: #374151;
            margin-bottom: 15px;
        }

        .toc ul {
            list-style: none;
            padding: 0;
        }

        .toc li {
            margin: 8px 0;
        }

        .toc a {
            color: #2563eb;
            text-decoration: none;
            padding: 5px 10px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .toc a:hover {
            background: #eff6ff;
        }

        /* 会话卡片样式 */
        .conversation-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .conversation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .conversation-id {
            font-family: monospace;
            background: #f3f4f6;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .conversation-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-completed {
            background: #dcfce7;
            color: #166534;
        }

        .status-running {
            background: #fef3c7;
            color: #92400e;
        }

        .status-error {
            background: #fee2e2;
            color: #dc2626;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }

            .main-content {
                margin-left: 0;
                padding: 20px;
            }

            .page-header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 侧边栏 -->
        <nav class="sidebar">
            <div class="logo">
                <h1><i class="fas fa-project-diagram"></i> MAG SDK</h1>
                <p>MCP Agent Graph 开发框架</p>
            </div>
            
            <ul class="nav">
                <li class="nav-item">
                    <a href="index.html" class="nav-link">
                        <i class="fas fa-home"></i>
                        概述
                    </a>
                </li>
                
                <li class="nav-group">
                    <div class="nav-group-title">
                        <span><i class="fas fa-cog"></i> 系统管理</span>
                        <i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="nav-group-content" style="max-height: 0;">
                        <a href="system.html#system-start" class="nav-link">
                            <i class="fas fa-play"></i>
                            启动服务
                        </a>
                        <a href="system.html#system-status" class="nav-link">
                            <i class="fas fa-info-circle"></i>
                            状态检查
                        </a>
                        <a href="system.html#system-shutdown" class="nav-link">
                            <i class="fas fa-stop"></i>
                            关闭服务
                        </a>
                    </div>
                </li>

                <li class="nav-group">
                    <div class="nav-group-title">
                        <span><i class="fas fa-project-diagram"></i> 图管理</span>
                        <i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="nav-group-content" style="max-height: 0;">
                        <a href="graph.html#graph-list" class="nav-link">列出图</a>
                        <a href="graph.html#graph-get" class="nav-link">获取图</a>
                        <a href="graph.html#graph-save" class="nav-link">保存图</a>
                        <a href="graph.html#graph-delete" class="nav-link">删除图</a>
                        <a href="graph.html#graph-run" class="nav-link">运行图</a>
                        <a href="graph.html#graph-import" class="nav-link">导入图</a>
                        <a href="graph.html#graph-export" class="nav-link">导出图</a>
                        <a href="graph.html#graph-mcp" class="nav-link">生成MCP脚本</a>
                    </div>
                </li>

                <li class="nav-group">
                    <div class="nav-group-title">
                        <span><i class="fas fa-brain"></i> 模型管理</span>
                        <i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="nav-group-content" style="max-height: 0;">
                        <a href="model.html#model-list" class="nav-link">列出模型</a>
                        <a href="model.html#model-add" class="nav-link">添加模型</a>
                        <a href="model.html#model-update" class="nav-link">更新模型</a>
                        <a href="model.html#model-delete" class="nav-link">删除模型</a>
                    </div>
                </li>

                <li class="nav-group">
                    <div class="nav-group-title">
                        <span><i class="fas fa-server"></i> MCP管理</span>
                        <i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="nav-group-content" style="max-height: 0;">
                        <a href="mcp.html#mcp-config" class="nav-link">配置管理</a>
                        <a href="mcp.html#mcp-status" class="nav-link">状态查看</a>
                        <a href="mcp.html#mcp-connect" class="nav-link">连接服务器</a>
                        <a href="mcp.html#mcp-tools" class="nav-link">工具管理</a>
                        <a href="mcp.html#mcp-servers" class="nav-link">服务器管理</a>
                    </div>
                </li>

                <li class="nav-group">
                    <div class="nav-group-title active">
                        <span><i class="fas fa-comments"></i> 会话管理</span>
                        <i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="nav-group-content">
                        <a href="#conversation-list" class="nav-link active">列出会话</a>
                        <a href="#conversation-get" class="nav-link">获取会话</a>
                        <a href="#conversation-delete" class="nav-link">删除会话</a>
                        <a href="#conversation-hierarchy" class="nav-link">会话层次结构</a>
                    </div>
                </li>

                <li class="nav-item">
                    <a href="examples.html" class="nav-link">
                        <i class="fas fa-code"></i>
                        示例教程
                    </a>
                </li>
            </ul>
        </nav>

        <!-- 主内容区域 -->
        <main class="main-content">
            <div class="page-header">
                <h1><i class="fas fa-comments"></i> 会话管理</h1>
                <p>智能体执行会话的查看、管理和操作</p>
            </div>

            <!-- 目录导航 -->
            <div class="toc">
                <h3><i class="fas fa-list"></i> 本页内容</h3>
                <ul>
                    <li><a href="#conversation-list">列出会话 - mag.list_conversations()</a></li>
                    <li><a href="#conversation-get">获取会话 - mag.get_conversation()</a></li>
                    <li><a href="#conversation-delete">删除会话 - mag.delete_conversation()</a></li>
                    <li><a href="#conversation-hierarchy">会话层次结构 - mag.get_conversation_hierarchy()</a></li>
                </ul>
            </div>

            <!-- 列出会话 -->
            <section class="section" id="conversation-list">
                <div class="function-card">
                    <div class="function-header">
                        <div class="function-icon">
                            <i class="fas fa-list"></i>
                        </div>
                        <div class="function-title">mag.list_conversations()</div>
                    </div>
                    
                    <p>获取系统中所有保存的会话列表。会话是智能体图执行的记录，包含输入、输出和中间过程。</p>

                    <h3>函数签名</h3>
                    <div class="code-block">
                        <button class="copy-btn" onclick="copyCode(this)">复制</button>
                        <pre><code class="language-python">def list_conversations() -> List[str]:
    """
    列出所有会话
    
    返回:
        List[str]: 会话ID列表
    """</code></pre>
                    </div>

                    <h3>返回值</h3>
                    <div class="return-value">
                        <h4><i class="fas fa-check-circle"></i> 返回值说明</h4>
                        <p><strong>List[str]</strong> - 包含所有会话ID的字符串列表</p>
                    </div>

                    <h3>使用示例</h3>
                    <div class="code-block">
                        <button class="copy-btn" onclick="copyCode(this)">复制</button>
                        <pre><code class="language-python">import mag

# 启动服务
mag.start()

# 获取所有会话列表
conversations = mag.list_conversations()
print(f"系统中共有 {len(conversations)} 个会话:")

# 显示会话列表
for i, conv_id in enumerate(conversations, 1):
    print(f"{i}. {conv_id}")

# 示例输出:
# 系统中共有 3 个会话:
# 1. conv_20241215_143022_abc123
# 2. conv_20241215_145030_def456  
# 3. conv_20241215_150145_ghi789
</code></pre>
                    </div>

                    <h3>会话信息展示</h3>
                    <div class="code-block">
                        <button class="copy-btn" onclick="copyCode(this)">复制</button>
                        <pre><code class="language-python">def display_conversations_summary():
    """显示会话摘要信息"""
    conversations = mag.list_conversations()
    
    if not conversations:
        print("📭 当前没有保存的会话")
        return
    
    print(f"📋 会话摘要 (共 {len(conversations)} 个会话):")
    print("-" * 60)
    
    for i, conv_id in enumerate(conversations, 1):
        try:
            # 获取会话详情
            conv_detail = mag.get_conversation(conv_id)
            
            print(f"\n{i}. 会话 {conv_id}")
            print(f"   图名称: {conv_detail.get('graph_name', '未知')}")
            print(f"   状态: {conv_detail.get('status', '未知')}")
            
            # 显示输出摘要（前100个字符）
            output = conv_detail.get('output', '')
            if output:
                output_preview = output[:100] + "..." if len(output) > 100 else output
                print(f"   输出预览: {output_preview}")
            
            # 显示附件信息
            attachments = conv_detail.get('attachments', [])
            if attachments:
                print(f"   附件: {len(attachments)} 个文件")
                
        except Exception as e:
            print(f"   错误: 无法获取会话详情 - {e}")

# 显示会话摘要
display_conversations_summary()
</code></pre>
                    </div>

                    <h3>按时间排序显示</h3>
                    <div class="code-block">
                        <button class="copy-btn" onclick="copyCode(this)">复制</button>
                        <pre><code class="language-python">import re
from datetime import datetime

def parse_conversation_timestamp(conv_id):
    """从会话ID中解析时间戳"""
    # 假设会话ID格式为: conv_YYYYMMDD_HHMMSS_xxx
    match = re.search(r'conv_(\d{8})_(\d{6})_', conv_id)
    if match:
        date_str = match.group(1)
        time_str = match.group(2)
        try:
            return datetime.strptime(f"{date_str}_{time_str}", "%Y%m%d_%H%M%S")
        except:
            pass
    return None

def display_conversations_by_time():
    """按时间排序显示会话"""
    conversations = mag.list_conversations()
    
    # 解析时间戳并排序
    conv_with_time = []
    conv_without_time = []
    
    for conv_id in conversations:
        timestamp = parse_conversation_timestamp(conv_id)
        if timestamp:
            conv_with_time.append((timestamp, conv_id))
        else:
            conv_without_time.append(conv_id)
    
    # 按时间排序（最新的在前）
    conv_with_time.sort(key=lambda x: x[0], reverse=True)
    
    print("📅 按时间排序的会话列表:")
    print("-" * 50)
    
    # 显示有时间戳的会话
    for timestamp, conv_id in conv_with_time:
        formatted_time = timestamp.strftime("%Y-%m-%d %H:%M:%S")
        print(f"🕒 {formatted_time} - {conv_id}")
    
    # 显示无法解析时间的会话
    if conv_without_time:
        print("\n📄 其他会话:")
        for conv_id in conv_without_time:
            print(f"   {conv_id}")

# 按时间显示会话
display_conversations_by_time()
</code></pre>
                    </div>
                </div>
            </section>

            <!-- 获取会话 -->
            <section class="section" id="conversation-get">
                <div class="function-card">
                    <div class="function-header">
                        <div class="function-icon">
                            <i class="fas fa-search"></i>
                        </div>
                        <div class="function-title">mag.get_conversation()</div>
                    </div>
                    
                    <p>获取指定会话的完整信息，包括执行结果、输出内容、附件等。</p>

                    <h3>函数签名</h3>
                    <div class="code-block">
                        <button class="copy-btn" onclick="copyCode(this)">复制</button>
                        <pre><code class="language-python">def get_conversation(conversation_id: str) -> Dict[str, Any]:
    """
    获取会话状态
    
    参数:
        conversation_id (str): 会话ID
    
    返回:
        Dict[str, Any]: 会话状态
    """</code></pre>
                    </div>

                    <h3>参数说明</h3>
                    <table class="param-table">
                        <thead>
                            <tr>
                                <th>参数名</th>
                                <th>类型</th>
                                <th>必需</th>
                                <th>说明</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>conversation_id</td>
                                <td>str</td>
                                <td>是</td>
                                <td>要获取的会话ID</td>
                            </tr>
                        </tbody>
                    </table>

                    <h3>使用示例</h3>
                    <div class="code-block">
                        <button class="copy-btn" onclick="copyCode(this)">复制</button>
                        <pre><code class="language-python">import mag

# 获取特定会话信息
conv_id = "conv_20241215_143022_abc123"
conversation = mag.get_conversation(conv_id)

print(f"会话ID: {conv_id}")
print(f"图名称: {conversation.get('graph_name', '未知')}")
print(f"状态: {conversation.get('status', '未知')}")

# 显示输出内容
output = conversation.get('output', '')
if output:
    print(f"\n📄 输出内容:")
    print(output)

# 显示附件信息
attachments = conversation.get('attachments', [])
if attachments:
    print(f"\n📎 附件 ({len(attachments)} 个):")
    for attachment in attachments:
        print(f"   • {attachment['name']} ({attachment['type']})")
        print(f"     路径: {attachment['path']}")
        print(f"     大小: {attachment.get('size', 'Unknown')} 字节")

# 显示节点执行结果
if 'node_results' in conversation:
    print(f"\n🔧 节点执行结果:")
    for node_id, result in conversation['node_results'].items():
        print(f"   节点: {node_id}")
        print(f"   状态: {result.get('status', '未知')}")
        if result.get('output'):
            output_preview = result['output'][:150] + "..." if len(result['output']) > 150 else result['output']
            print(f"   输出: {output_preview}")
</code></pre>
                    </div>

                    <h3>处理附件内容</h3>
                    <div class="code-block">
                        <button class="copy-btn" onclick="copyCode(this)">复制</button>
                        <pre><code class="language-python">def display_conversation_attachments(conv_id):
    """显示会话附件并处理不同类型的文件"""
    conversation = mag.get_conversation(conv_id)
    attachments = conversation.get('attachments', [])
    
    if not attachments:
        print("📭 此会话没有附件")
        return
    
    print(f"📎 会话 {conv_id} 的附件:")
    print("-" * 50)
    
    for i, attachment in enumerate(attachments, 1):
        file_name = attachment['name']
        file_type = attachment['type'].lower()
        file_path = attachment['path']
        
        print(f"\n{i}. {file_name} ({file_type.upper()})")
        print(f"   路径: {file_path}")
        print(f"   大小: {attachment.get('size', 'Unknown')} 字节")
        
        # 根据文件类型显示内容预览
        try:
            if file_type in ['md', 'txt']:
                with open(file_path, 'r', encoding='utf-8') as f:
                    content = f.read()
                    preview = content[:300] + "..." if len(content) > 300 else content
                    print(f"   预览:\n{preview}")
            
            elif file_type == 'json':
                with open(file_path, 'r', encoding='utf-8') as f:
                    import json
                    data = json.load(f)
                    print(f"   JSON结构: {type(data).__name__}")
                    if isinstance(data, dict):
                        print(f"   键数量: {len(data)}")
                    elif isinstance(data, list):
                        print(f"   元素数量: {len(data)}")
            
            elif file_type in ['jpg', 'png', 'gif', 'pdf']:
                print(f"   类型: {file_type.upper()} 文件")
                print("   提示: 需要使用对应的应用程序打开")
                
        except Exception as e:
            print(f"   错误: 无法读取文件 - {e}")

# 显示会话附件
conversations = mag.list_conversations()
if conversations:
    display_conversation_attachments(conversations[0])
</code></pre>
                    </div>

                    <h3>会话结果分析</h3>
                    <div class="code-block">
                        <button class="copy-btn" onclick="copyCode(this)">复制</button>
                        <pre><code class="language-python">def analyze_conversation_performance(conv_id):
    """分析会话的执行性能和结果"""
    conversation = mag.get_conversation(conv_id)
    
    print(f"📊 会话 {conv_id} 性能分析:")
    print("-" * 50)
    
    # 基本信息
    print(f"图名称: {conversation.get('graph_name', '未知')}")
    print(f"执行状态: {conversation.get('status', '未知')}")
    
    # 节点分析
    node_results = conversation.get('node_results', {})
    if node_results:
        total_nodes = len(node_results)
        successful_nodes = sum(1 for result in node_results.values() 
                              if result.get('status') == 'success')
        
        print(f"\n🔧 节点执行统计:")
        print(f"   总节点数: {total_nodes}")
        print(f"   成功节点: {successful_nodes}")
        print(f"   成功率: {successful_nodes/total_nodes*100:.1f}%")
        
        # 显示失败的节点
        failed_nodes = [node_id for node_id, result in node_results.items() 
                       if result.get('status') != 'success']
        if failed_nodes:
            print(f"   失败节点: {failed_nodes}")
    
    # 输出分析
    output = conversation.get('output', '')
    if output:
        print(f"\n📄 输出分析:")
        print(f"   输出长度: {len(output)} 字符")
        print(f"   行数: {output.count('\\n') + 1}")
    
    # 附件分析
    attachments = conversation.get('attachments', [])
    if attachments:
        print(f"\n📎 附件分析:")
        print(f"   附件数量: {len(attachments)}")
        
        total_size = sum(att.get('size', 0) for att in attachments)
        print(f"   总大小: {total_size:,} 字节")
        
        file_types = {}
        for att in attachments:
            file_type = att['type']
            file_types[file_type] = file_types.get(file_type, 0) + 1
        
        print(f"   文件类型分布:")
        for file_type, count in file_types.items():
            print(f"     {file_type}: {count} 个")

# 分析会话性能
conversations = mag.list_conversations()
if conversations:
    analyze_conversation_performance(conversations[0])
</code></pre>
                    </div>
                </div>
            </section>

            <!-- 删除会话 -->
            <section class="section" id="conversation-delete">
                <div class="function-card">
                    <div class="function-header">
                        <div class="function-icon">
                            <i class="fas fa-trash"></i>
                        </div>
                        <div class="function-title">mag.delete_conversation()</div>
                    </div>
                    
                    <p>删除指定的会话及其相关文件。此操作会永久删除会话数据，请谨慎操作。</p>

                    <h3>函数签名</h3>
                    <div class="code-block">
                        <button class="copy-btn" onclick="copyCode(this)">复制</button>
                        <pre><code class="language-python">def delete_conversation(conversation_id: str) -> Dict[str, Any]:
    """
    删除会话
    
    参数:
        conversation_id (str): 会话ID
    
    返回:
        Dict[str, Any]: 操作结果
    """</code></pre>
                    </div>

                    <h3>使用示例</h3>
                    <div class="code-block">
                        <button class="copy-btn" onclick="copyCode(this)">复制</button>
                        <pre><code class="language-python">import mag

# 删除单个会话
conv_id = "conv_20241215_143022_abc123"
result = mag.delete_conversation(conv_id)
print(f"删除结果: {result}")

# 安全删除（带确认）
def safe_delete_conversation(conv_id):
    """安全地删除会话，包含确认步骤"""
    try:
        # 获取会话信息
        conversation = mag.get_conversation(conv_id)
        
        print(f"即将删除会话: {conv_id}")
        print(f"图名称: {conversation.get('graph_name', '未知')}")
        print(f"状态: {conversation.get('status', '未知')}")
        
        # 显示附件信息
        attachments = conversation.get('attachments', [])
        if attachments:
            print(f"附件数量: {len(attachments)} 个")
            total_size = sum(att.get('size', 0) for att in attachments)
            print(f"总大小: {total_size:,} 字节")
        
        # 确认删除
        confirm = input("确认删除此会话及所有相关文件? (yes/no): ")
        if confirm.lower() == 'yes':
            result = mag.delete_conversation(conv_id)
            if result.get("status") == "success":
                print(f"✅ 会话 '{conv_id}' 已删除")
                return True
            else:
                print(f"❌ 删除失败: {result.get('message', 'Unknown error')}")
                return False
        else:
            print("取消删除操作")
            return False
            
    except Exception as e:
        print(f"删除过程中出错: {e}")
        return False

# 使用安全删除
safe_delete_conversation("conv_20241215_143022_abc123")
</code></pre>
                    </div>

                    <h3>批量删除会话</h3>
                    <div class="code-block">
                        <button class="copy-btn" onclick="copyCode(this)">复制</button>
                        <pre><code class="language-python">def batch_delete_conversations(conversation_ids, confirm=True):
    """批量删除会话"""
    if not conversation_ids:
        print("没有会话需要删除")
        return
    
    if confirm:
        print(f"即将删除 {len(conversation_ids)} 个会话:")
        for conv_id in conversation_ids:
            try:
                conv = mag.get_conversation(conv_id)
                print(f"  • {conv_id} - {conv.get('graph_name', '未知图')}")
            except:
                print(f"  • {conv_id} - 无法获取详情")
        
        confirm_input = input("确认批量删除? (yes/no): ")
        if confirm_input.lower() != 'yes':
            print("取消批量删除操作")
            return
    
    results = []
    for conv_id in conversation_ids:
        try:
            result = mag.delete_conversation(conv_id)
            if result.get("status") == "success":
                print(f"✅ 删除 '{conv_id}' 成功")
                results.append({"id": conv_id, "status": "success"})
            else:
                print(f"❌ 删除 '{conv_id}' 失败: {result.get('message', 'Unknown error')}")
                results.append({"id": conv_id, "status": "failed", "message": result.get('message', '')})
        except Exception as e:
            print(f"❌ 删除 '{conv_id}' 出错: {e}")
            results.append({"id": conv_id, "status": "error", "message": str(e)})
    
    successful = sum(1 for r in results if r["status"] == "success")
    print(f"\n批量删除完成: 成功 {successful}/{len(conversation_ids)} 个")
    return results

# 批量删除示例
conversations_to_delete = ["conv_1", "conv_2", "conv_3"]
batch_delete_conversations(conversations_to_delete)
</code></pre>
                    </div>

                    <h3>清理旧会话</h3>
                    <div class="code-block">
                        <button class="copy-btn" onclick="copyCode(this)">复制</button>
                        <pre><code class="language-python">from datetime import datetime, timedelta

def cleanup_old_conversations(days_old=30, dry_run=True):
    """清理指定天数前的旧会话"""
    conversations = mag.list_conversations()
    cutoff_date = datetime.now() - timedelta(days=days_old)
    
    old_conversations = []
    
    for conv_id in conversations:
        timestamp = parse_conversation_timestamp(conv_id)
        if timestamp and timestamp < cutoff_date:
            old_conversations.append((conv_id, timestamp))
    
    if not old_conversations:
        print(f"没有找到 {days_old} 天前的会话")
        return
    
    # 按时间排序
    old_conversations.sort(key=lambda x: x[1])
    
    print(f"发现 {len(old_conversations)} 个超过 {days_old} 天的会话:")
    total_size = 0
    
    for conv_id, timestamp in old_conversations:
        try:
            conv = mag.get_conversation(conv_id)
            attachments = conv.get('attachments', [])
            conv_size = sum(att.get('size', 0) for att in attachments)
            total_size += conv_size
            
            formatted_time = timestamp.strftime("%Y-%m-%d %H:%M")
            print(f"  • {conv_id} ({formatted_time}) - {conv_size:,} 字节")
        except:
            print(f"  • {conv_id} - 无法获取详情")
    
    print(f"\n总计大小: {total_size:,} 字节 ({total_size/1024/1024:.1f} MB)")
    
    if dry_run:
        print("\n这是预览模式，没有实际删除任何文件")
        print("要执行实际删除，请设置 dry_run=False")
        return
    
    # 确认删除
    confirm = input(f"确认删除这 {len(old_conversations)} 个旧会话? (yes/no): ")
    if confirm.lower() == 'yes':
        conv_ids = [conv_id for conv_id, _ in old_conversations]
        batch_delete_conversations(conv_ids, confirm=False)
    else:
        print("取消清理操作")

# 预览30天前的会话（不实际删除）
cleanup_old_conversations(days_old=30, dry_run=True)

# 实际清理（去除dry_run参数或设为False）
# cleanup_old_conversations(days_old=30, dry_run=False)
</code></pre>
                    </div>

                    <div class="note">
                        <h4><i class="fas fa-exclamation-triangle"></i> 删除注意事项</h4>
                        <p>• 删除操作不可逆，请务必谨慎<br>
                        • 删除会话会同时删除所有相关的附件文件<br>
                        • 建议在删除前备份重要的会话数据<br>
                        • 批量删除时建议先使用预览模式确认</p>
                    </div>
                </div>
            </section>

            <!-- 会话层次结构 -->
            <section class="section" id="conversation-hierarchy">
                <div class="function-card">
                    <div class="function-header">
                        <div class="function-icon">
                            <i class="fas fa-sitemap"></i>
                        </div>
                        <div class="function-title">mag.get_conversation_hierarchy()</div>
                    </div>
                    
                    <p>获取会话的层次结构信息，特别适用于包含嵌套图执行的复杂会话。</p>

                    <h3>函数签名</h3>
                    <div class="code-block">
                        <button class="copy-btn" onclick="copyCode(this)">复制</button>
                        <pre><code class="language-python">def get_conversation_hierarchy(conversation_id: str) -> Dict[str, Any]:
    """
    获取会话层次结构
    
    参数:
        conversation_id (str): 会话ID
    
    返回:
        Dict[str, Any]: 会话层次结构
    """</code></pre>
                    </div>

                    <h3>使用示例</h3>
                    <div class="code-block">
                        <button class="copy-btn" onclick="copyCode(this)">复制</button>
                        <pre><code class="language-python">import mag

# 获取会话层次结构
conv_id = "conv_20241215_143022_abc123"
hierarchy = mag.get_conversation_hierarchy(conv_id)

print(f"会话层次结构: {conv_id}")
print("-" * 50)

def display_hierarchy(data, level=0):
    """递归显示层次结构"""
    indent = "  " * level
    
    if isinstance(data, dict):
        for key, value in data.items():
            if key == 'children' and isinstance(value, list):
                for i, child in enumerate(value):
                    print(f"{indent}├─ 子任务 {i+1}")
                    display_hierarchy(child, level + 1)
            elif key in ['node_id', 'graph_name', 'status', 'output']:
                if key == 'output' and len(str(value)) > 100:
                    value = str(value)[:100] + "..."
                print(f"{indent}{key}: {value}")

display_hierarchy(hierarchy)

# 分析层次结构
def analyze_hierarchy(hierarchy):
    """分析会话的层次结构"""
    def count_levels(data, current_level=0):
        max_level = current_level
        if isinstance(data, dict) and 'children' in data:
            for child in data['children']:
                max_level = max(max_level, count_levels(child, current_level + 1))
        return max_level
    
    def count_nodes(data):
        count = 1  # 当前节点
        if isinstance(data, dict) and 'children' in data:
            for child in data['children']:
                count += count_nodes(child)
        return count
    
    max_depth = count_levels(hierarchy)
    total_nodes = count_nodes(hierarchy)
    
    print(f"\n📊 层次结构分析:")
    print(f"   最大深度: {max_depth} 层")
    print(f"   总节点数: {total_nodes} 个")
    
    return {"max_depth": max_depth, "total_nodes": total_nodes}

# 执行分析
stats = analyze_hierarchy(hierarchy)
</code></pre>
                    </div>

                    <h3>可视化层次结构</h3>
                    <div class="code-block">
                        <button class="copy-btn" onclick="copyCode(this)">复制</button>
                        <pre><code class="language-python">def visualize_conversation_tree(conv_id):
    """可视化会话的树形结构"""
    hierarchy = mag.get_conversation_hierarchy(conv_id)
    
    def draw_tree(data, prefix="", is_last=True, level=0):
        if level == 0:
            print(f"🌳 会话树: {conv_id}")
        
        # 决定当前节点的连接符
        current_prefix = "└── " if is_last else "├── "
        
        # 显示节点信息
        node_info = ""
        if isinstance(data, dict):
            node_id = data.get('node_id', 'unknown')
            status = data.get('status', 'unknown')
            
            # 状态图标
            status_icon = {
                'success': '✅',
                'running': '🔄', 
                'error': '❌',
                'pending': '⏳'
            }.get(status, '❓')
            
            node_info = f"{status_icon} {node_id} ({status})"
        
        print(f"{prefix}{current_prefix}{node_info}")
        
        # 处理子节点
        if isinstance(data, dict) and 'children' in data:
            children = data['children']
            for i, child in enumerate(children):
                is_child_last = (i == len(children) - 1)
                child_prefix = prefix + ("    " if is_last else "│   ")
                draw_tree(child, child_prefix, is_child_last, level + 1)
    
    draw_tree(hierarchy)

# 可视化会话树
conversations = mag.list_conversations()
if conversations:
    visualize_conversation_tree(conversations[0])
</code></pre>
                    </div>
                </div>
            </section>

            <!-- 会话管理最佳实践 -->
            <section class="section">
                <h2><i class="fas fa-lightbulb"></i> 会话管理最佳实践</h2>

                <h3>会话监控和维护</h3>
                <div class="code-block">
                    <button class="copy-btn" onclick="copyCode(this)">复制</button>
                    <pre><code class="language-python">class ConversationManager:
    """会话管理器"""
    
    def __init__(self):
        self.conversations = {}
        self.load_conversations()
    
    def load_conversations(self):
        """加载所有会话"""
        try:
            conv_ids = mag.list_conversations()
            for conv_id in conv_ids:
                try:
                    conv_data = mag.get_conversation(conv_id)
                    self.conversations[conv_id] = conv_data
                except Exception as e:
                    print(f"警告: 无法加载会话 {conv_id}: {e}")
        except Exception as e:
            print(f"加载会话列表失败: {e}")
    
    def get_statistics(self):
        """获取会话统计信息"""
        total = len(self.conversations)
        if total == 0:
            return {"total": 0}
        
        status_count = {}
        graph_count = {}
        total_attachments = 0
        total_size = 0
        
        for conv_data in self.conversations.values():
            # 统计状态
            status = conv_data.get('status', 'unknown')
            status_count[status] = status_count.get(status, 0) + 1
            
            # 统计图名称
            graph_name = conv_data.get('graph_name', 'unknown')
            graph_count[graph_name] = graph_count.get(graph_name, 0) + 1
            
            # 统计附件
            attachments = conv_data.get('attachments', [])
            total_attachments += len(attachments)
            total_size += sum(att.get('size', 0) for att in attachments)
        
        return {
            "total": total,
            "status_distribution": status_count,
            "graph_distribution": graph_count,
            "total_attachments": total_attachments,
            "total_size": total_size
        }
    
    def print_dashboard(self):
        """打印会话仪表板"""
        stats = self.get_statistics()
        
        print("📊 会话管理仪表板")
        print("=" * 50)
        print(f"总会话数: {stats['total']}")
        
        if stats['total'] > 0:
            print(f"总附件数: {stats['total_attachments']}")
            print(f"总存储大小: {stats['total_size']:,} 字节 ({stats['total_size']/1024/1024:.1f} MB)")
            
            print("\n📈 状态分布:")
            for status, count in stats['status_distribution'].items():
                percentage = count / stats['total'] * 100
                print(f"   {status}: {count} ({percentage:.1f}%)")
            
            print("\n📋 图使用分布:")
            for graph, count in sorted(stats['graph_distribution'].items(), 
                                     key=lambda x: x[1], reverse=True):
                percentage = count / stats['total'] * 100
                print(f"   {graph}: {count} ({percentage:.1f}%)")
    
    def cleanup_failed_conversations(self, confirm=True):
        """清理失败的会话"""
        failed_convs = [conv_id for conv_id, conv_data in self.conversations.items()
                       if conv_data.get('status') in ['error', 'failed']]
        
        if not failed_convs:
            print("没有找到失败的会话")
            return
        
        print(f"发现 {len(failed_convs)} 个失败的会话:")
        for conv_id in failed_convs:
            conv_data = self.conversations[conv_id]
            print(f"  • {conv_id} - {conv_data.get('graph_name', 'unknown')}")
        
        if confirm:
            confirm_input = input("确认删除所有失败的会话? (yes/no): ")
            if confirm_input.lower() != 'yes':
                print("取消清理操作")
                return
        
        batch_delete_conversations(failed_convs, confirm=False)
        self.load_conversations()  # 重新加载

# 使用会话管理器
manager = ConversationManager()
manager.print_dashboard()

# 清理失败的会话
manager.cleanup_failed_conversations()
</code></pre>
                </div>

                <h3>会话备份和恢复</h3>
                <div class="code-block">
                    <button class="copy-btn" onclick="copyCode(this)">复制</button>
                    <pre><code class="language-python">import json
import shutil
from pathlib import Path

def backup_conversations(backup_dir="conversation_backup"):
    """备份所有会话"""
    backup_path = Path(backup_dir)
    backup_path.mkdir(exist_ok=True)
    
    conversations = mag.list_conversations()
    backup_info = {
        "backup_date": datetime.now().isoformat(),
        "total_conversations": len(conversations),
        "conversations": []
    }
    
    print(f"开始备份 {len(conversations)} 个会话到 {backup_path}")
    
    for conv_id in conversations:
        try:
            # 获取会话数据
            conv_data = mag.get_conversation(conv_id)
            
            # 创建会话备份目录
            conv_backup_dir = backup_path / conv_id
            conv_backup_dir.mkdir(exist_ok=True)
            
            # 保存会话元数据
            metadata = {
                "conversation_id": conv_id,
                "graph_name": conv_data.get('graph_name'),
                "status": conv_data.get('status'),
                "output": conv_data.get('output')
            }
            
            with open(conv_backup_dir / "metadata.json", 'w', encoding='utf-8') as f:
                json.dump(metadata, f, indent=2, ensure_ascii=False)
            
            # 复制附件
            attachments = conv_data.get('attachments', [])
            if attachments:
                attachments_dir = conv_backup_dir / "attachments"
                attachments_dir.mkdir(exist_ok=True)
                
                for attachment in attachments:
                    source_path = Path(attachment['path'])
                    if source_path.exists():
                        dest_path = attachments_dir / attachment['name']
                        shutil.copy2(source_path, dest_path)
            
            backup_info["conversations"].append({
                "id": conv_id,
                "status": "success",
                "attachments_count": len(attachments)
            })
            
            print(f"✅ 备份完成: {conv_id}")
            
        except Exception as e:
            print(f"❌ 备份失败: {conv_id} - {e}")
            backup_info["conversations"].append({
                "id": conv_id,
                "status": "failed",
                "error": str(e)
            })
    
    # 保存备份信息
    with open(backup_path / "backup_info.json", 'w', encoding='utf-8') as f:
        json.dump(backup_info, f, indent=2, ensure_ascii=False)
    
    successful = sum(1 for conv in backup_info["conversations"] if conv["status"] == "success")
    print(f"\n备份完成: {successful}/{len(conversations)} 个会话成功备份")
    
    return backup_path

# 执行备份
backup_path = backup_conversations()
print(f"备份已保存到: {backup_path}")
</code></pre>
                </div>
            </section>
        </main>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script>
        // 复制代码功能
        function copyCode(button) {
            const code = button.nextElementSibling.textContent;
            navigator.clipboard.writeText(code).then(() => {
                const originalText = button.textContent;
                button.textContent = '已复制!';
                button.style.background = '#10b981';
                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.background = '#4b5563';
                }, 2000);
            });
        }

        // 导航链接点击处理
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                // 移除其他活动状态
                document.querySelectorAll('.nav-link.active').forEach(el => {
                    el.classList.remove('active');
                });
                // 添加活动状态到当前链接
                e.target.classList.add('active');
            });
        });

        // 页面内锚点滚动
        document.querySelectorAll('a[href^="#"]').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const target = document.querySelector(link.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({ behavior: 'smooth' });
                }
            });
        });

        // 代码高亮
        Prism.highlightAll();
    </script>
</body>
</html>