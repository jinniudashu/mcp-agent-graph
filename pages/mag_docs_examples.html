<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>示例教程 - MAG SDK 使用文档</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #fafafa;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* 侧边栏样式 */
        .sidebar {
            width: 280px;
            background: #fff;
            border-right: 1px solid #e1e5e9;
            padding: 20px 0;
            overflow-y: auto;
            position: fixed;
            height: 100vh;
            z-index: 1000;
        }

        .logo {
            padding: 0 20px 20px;
            border-bottom: 1px solid #e1e5e9;
            margin-bottom: 20px;
        }

        .logo h1 {
            color: #2563eb;
            font-size: 24px;
            font-weight: 700;
        }

        .logo p {
            color: #6b7280;
            font-size: 14px;
            margin-top: 5px;
        }

        .nav {
            list-style: none;
        }

        .nav-item {
            margin-bottom: 5px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 10px 20px;
            color: #4b5563;
            text-decoration: none;
            transition: all 0.2s;
            border-right: 3px solid transparent;
        }

        .nav-link:hover {
            background-color: #f3f4f6;
            color: #2563eb;
        }

        .nav-link.active {
            background-color: #eff6ff;
            color: #2563eb;
            border-right-color: #2563eb;
        }

        .nav-link i {
            margin-right: 10px;
            width: 16px;
        }

        /* 折叠菜单样式 */
        .nav-group {
            margin-bottom: 10px;
        }

        .nav-group-title {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 20px;
            color: #374151;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .nav-group-title:hover {
            background-color: #f9fafb;
            color: #2563eb;
        }

        .nav-group-title.active {
            background-color: #eff6ff;
            color: #2563eb;
        }

        .nav-group-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .nav-group-content .nav-link {
            padding-left: 50px;
            font-size: 14px;
        }

        .chevron {
            transition: transform 0.3s ease;
        }

        /* 主内容区域 */
        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 40px 60px;
            background: #fff;
            min-height: 100vh;
        }

        /* 页面头部 */
        .page-header {
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e5e7eb;
        }

        .page-header h1 {
            color: #1f2937;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .page-header p {
            color: #6b7280;
            font-size: 1.1rem;
        }

        /* 内容区块 */
        .section {
            margin-bottom: 50px;
        }

        .section h2 {
            color: #1f2937;
            font-size: 1.8rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section h3 {
            color: #374151;
            font-size: 1.3rem;
            margin: 30px 0 15px;
        }

        .section p {
            color: #6b7280;
            line-height: 1.8;
            margin-bottom: 20px;
        }

        /* 代码块样式 */
        .code-block {
            background: #1a1a1a;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            position: relative;
            overflow-x: auto;
        }

        .code-block pre {
            margin: 0;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
            line-height: 1.5;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .copy-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #4b5563;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.2s;
        }

        .copy-btn:hover {
            background: #6b7280;
        }

        /* 示例卡片 */
        .example-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 30px;
            margin: 30px 0;
            transition: all 0.3s ease;
        }

        .example-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .example-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .example-icon {
            background: #2563eb;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 1.5rem;
        }

        .example-title {
            color: #1f2937;
            font-size: 1.4rem;
            font-weight: 600;
        }

        /* 注意事项 */
        .note {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }

        .note h4 {
            color: #92400e;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .note p {
            color: #b45309;
            margin: 0;
        }

        /* 成功提示 */
        .success {
            background: #ecfdf5;
            border: 1px solid #a7f3d0;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }

        .success h4 {
            color: #065f46;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .success p {
            color: #047857;
            margin: 0;
        }

        /* 目录导航 */
        .toc {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .toc h3 {
            color: #374151;
            margin-bottom: 15px;
        }

        .toc ul {
            list-style: none;
            padding: 0;
        }

        .toc li {
            margin: 8px 0;
        }

        .toc a {
            color: #2563eb;
            text-decoration: none;
            padding: 5px 10px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .toc a:hover {
            background: #eff6ff;
        }

        /* 步骤指示器 */
        .steps {
            display: grid;
            gap: 20px;
            margin: 30px 0;
        }

        .step {
            display: flex;
            align-items: flex-start;
            background: white;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #2563eb;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .step-number {
            background: #2563eb;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
            flex-shrink: 0;
        }

        .step-content h4 {
            color: #1f2937;
            margin-bottom: 10px;
        }

        .step-content p {
            margin: 0;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }

            .main-content {
                margin-left: 0;
                padding: 20px;
            }

            .page-header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 侧边栏 -->
        <nav class="sidebar">
            <div class="logo">
                <h1><i class="fas fa-project-diagram"></i> MAG SDK</h1>
                <p>MCP Agent Graph 开发框架</p>
            </div>
            
            <ul class="nav">
                <li class="nav-item">
                    <a href="index.html" class="nav-link">
                        <i class="fas fa-home"></i>
                        概述
                    </a>
                </li>
                
                <li class="nav-group">
                    <div class="nav-group-title">
                        <span><i class="fas fa-cog"></i> 系统管理</span>
                        <i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="nav-group-content" style="max-height: 0;">
                        <a href="system.html#system-start" class="nav-link">
                            <i class="fas fa-play"></i>
                            启动服务
                        </a>
                        <a href="system.html#system-status" class="nav-link">
                            <i class="fas fa-info-circle"></i>
                            状态检查
                        </a>
                        <a href="system.html#system-shutdown" class="nav-link">
                            <i class="fas fa-stop"></i>
                            关闭服务
                        </a>
                    </div>
                </li>

                <li class="nav-group">
                    <div class="nav-group-title">
                        <span><i class="fas fa-project-diagram"></i> 图管理</span>
                        <i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="nav-group-content" style="max-height: 0;">
                        <a href="graph.html#graph-list" class="nav-link">列出图</a>
                        <a href="graph.html#graph-get" class="nav-link">获取图</a>
                        <a href="graph.html#graph-save" class="nav-link">保存图</a>
                        <a href="graph.html#graph-delete" class="nav-link">删除图</a>
                        <a href="graph.html#graph-run" class="nav-link">运行图</a>
                        <a href="graph.html#graph-import" class="nav-link">导入图</a>
                        <a href="graph.html#graph-export" class="nav-link">导出图</a>
                        <a href="graph.html#graph-mcp" class="nav-link">生成MCP脚本</a>
                    </div>
                </li>

                <li class="nav-group">
                    <div class="nav-group-title">
                        <span><i class="fas fa-brain"></i> 模型管理</span>
                        <i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="nav-group-content" style="max-height: 0;">
                        <a href="model.html#model-list" class="nav-link">列出模型</a>
                        <a href="model.html#model-add" class="nav-link">添加模型</a>
                        <a href="model.html#model-update" class="nav-link">更新模型</a>
                        <a href="model.html#model-delete" class="nav-link">删除模型</a>
                    </div>
                </li>

                <li class="nav-group">
                    <div class="nav-group-title">
                        <span><i class="fas fa-server"></i> MCP管理</span>
                        <i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="nav-group-content" style="max-height: 0;">
                        <a href="mcp.html#mcp-config" class="nav-link">配置管理</a>
                        <a href="mcp.html#mcp-status" class="nav-link">状态查看</a>
                        <a href="mcp.html#mcp-connect" class="nav-link">连接服务器</a>
                        <a href="mcp.html#mcp-tools" class="nav-link">工具管理</a>
                        <a href="mcp.html#mcp-servers" class="nav-link">服务器管理</a>
                    </div>
                </li>

                <li class="nav-group">
                    <div class="nav-group-title">
                        <span><i class="fas fa-comments"></i> 会话管理</span>
                        <i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="nav-group-content" style="max-height: 0;">
                        <a href="conversation.html#conversation-list" class="nav-link">列出会话</a>
                        <a href="conversation.html#conversation-get" class="nav-link">获取会话</a>
                        <a href="conversation.html#conversation-delete" class="nav-link">删除会话</a>
                    </div>
                </li>

                <li class="nav-item">
                    <a href="#examples" class="nav-link active">
                        <i class="fas fa-code"></i>
                        示例教程
                    </a>
                </li>
            </ul>
        </nav>

        <!-- 主内容区域 -->
        <main class="main-content">
            <div class="page-header">
                <h1><i class="fas fa-code"></i> 示例教程</h1>
                <p>完整的使用示例、最佳实践和应用场景指南</p>
            </div>

            <!-- 目录导航 -->
            <div class="toc">
                <h3><i class="fas fa-list"></i> 本页内容</h3>
                <ul>
                    <li><a href="#quick-start">快速入门</a></li>
                    <li><a href="#complete-workflow">完整工作流示例</a></li>
                    <li><a href="#use-cases">常见使用场景</a></li>
                    <li><a href="#best-practices">最佳实践</a></li>
                    <li><a href="#troubleshooting">故障排除</a></li>
                    <li><a href="#advanced-usage">高级用法</a></li>
                </ul>
            </div>

            <!-- 快速入门 -->
            <section class="section" id="quick-start">
                <div class="example-card">
                    <div class="example-header">
                        <div class="example-icon">
                            <i class="fas fa-rocket"></i>
                        </div>
                        <div class="example-title">快速入门示例</div>
                    </div>
                    
                    <p>这个示例将带您快速体验MAG SDK的核心功能：从启动服务到运行您的第一个智能体图。</p>

                    <div class="steps">
                        <div class="step">
                            <div class="step-number">1</div>
                            <div class="step-content">
                                <h4>安装和启动</h4>
                                <p>安装MAG SDK并启动服务</p>
                            </div>
                        </div>
                    </div>

                    <div class="code-block">
                        <button class="copy-btn" onclick="copyCode(this)">复制</button>
                        <pre><code class="language-python"># 安装MAG SDK
# pip install mcp-agent-graph

import mag

# 启动MAG服务
print("正在启动MAG服务...")
if mag.start():
    print("✅ MAG服务启动成功！")
else:
    print("❌ 服务启动失败")
    exit(1)

# 验证服务状态
if mag.is_running():
    print("✅ 服务运行正常")
else:
    print("❌ 服务未正常运行")
</code></pre>
                    </div>

                    <div class="steps">
                        <div class="step">
                            <div class="step-number">2</div>
                            <div class="step-content">
                                <h4>配置模型</h4>
                                <p>添加您的第一个AI模型</p>
                            </div>
                        </div>
                    </div>

                    <div class="code-block">
                        <button class="copy-btn" onclick="copyCode(this)">复制</button>
                        <pre><code class="language-python"># 添加AI模型配置
model_config = {
    "name": "gpt-4",
    "base_url": "https://api.openai.com/v1/",
    "api_key": "your-openai-api-key-here",  # 请替换为您的实际API密钥
    "model": "gpt-4"
}

result = mag.add_model(model_config)
if result.get("status") == "success":
    print("✅ 模型添加成功")
else:
    print(f"❌ 模型添加失败: {result.get('message')}")

# 验证模型列表
models = mag.list_models()
print(f"当前配置的模型: {[m['name'] for m in models]}")
</code></pre>
                    </div>

                    <div class="steps">
                        <div class="step">
                            <div class="step-number">3</div>
                            <div class="step-content">
                                <h4>创建简单图</h4>
                                <p>创建您的第一个智能体图</p>
                            </div>
                        </div>
                    </div>

                    <div class="code-block">
                        <button class="copy-btn" onclick="copyCode(this)">复制</button>
                        <pre><code class="language-python"># 创建一个简单的聊天图
simple_graph = {
    "name": "hello_world",
    "description": "我的第一个MAG图",
    "nodes": [
        {
            "id": "chat_node",
            "name": "聊天助手",
            "type": "agent",
            "model_name": "gpt-4",
            "system_prompt": "你是一个友好的AI助手，请用简洁明了的方式回答问题。",
            "user_prompt": "用户问题：{input}\\n\\n请提供有帮助的回答。",
            "mcp_servers": [],
            "position": {"x": 100, "y": 100}
        }
    ],
    "edges": [],
    "version": "1.0"
}

# 保存图
result = mag.save_graph(simple_graph)
if result.get("status") == "success":
    print("✅ 图创建成功")
    
    # 查看图列表
    graphs = mag.list_graphs()
    print(f"当前图列表: {graphs}")
else:
    print(f"❌ 图创建失败: {result.get('message')}")
</code></pre>
                    </div>

                    <div class="steps">
                        <div class="step">
                            <div class="step-number">4</div>
                            <div class="step-content">
                                <h4>运行图</h4>
                                <p>执行您的智能体图</p>
                            </div>
                        </div>
                    </div>

                    <div class="code-block">
                        <button class="copy-btn" onclick="copyCode(this)">复制</button>
                        <pre><code class="language-python"># 运行图
print("正在运行图...")
result = mag.run_graph(
    name="hello_world",
    input_text="你好，请介绍一下MAG框架的主要功能。",
    parallel=False
)

# 处理结果
if result.get("status") == "success":
    print("✅ 图执行成功")
    print(f"会话ID: {result['conversation_id']}")
    print(f"输出结果：")
    print("-" * 50)
    print(result.get("output", ""))
    print("-" * 50)
else:
    print(f"❌ 图执行失败: {result.get('error', 'Unknown error')}")

# 清理（可选）
print("\\n正在关闭服务...")
mag.shutdown()
print("✅ 服务已关闭")
</code></pre>
                    </div>

                    <div class="success">
                        <h4><i class="fas fa-check-circle"></i> 恭喜！</h4>
                        <p>您已经成功运行了第一个MAG智能体图！接下来可以探索更复杂的功能和使用场景。</p>
                    </div>
                </div>
            </section>

            <!-- 完整工作流示例 -->
            <section class="section" id="complete-workflow">
                <div class="example-card">
                    <div class="example-header">
                        <div class="example-icon">
                            <i class="fas fa-cogs"></i>
                        </div>
                        <div class="example-title">完整工作流示例</div>
                    </div>
                    
                    <p>这个示例演示一个包含搜索、分析和报告生成的完整研究工作流。</p>

                    <h3>场景描述</h3>
                    <p>创建一个研究助手图，能够：</p>
                    <ul style="margin: 15px 0; padding-left: 20px;">
                        <li>使用Tavily搜索引擎搜索相关信息</li>
                        <li>分析搜索结果并提取关键信息</li>
                        <li>生成结构化的研究报告</li>
                    </ul>

                    <h3>步骤1：设置环境</h3>
                    <div class="code-block">
                        <button class="copy-btn" onclick="copyCode(this)">复制</button>
                        <pre><code class="language-python">import mag
import json
import time
from datetime import datetime

# 启动服务
print("启动MAG服务...")
if not mag.start():
    print("❌ 服务启动失败")
    exit(1)

print("✅ 服务启动成功")
</code></pre>
                    </div>

                    <h3>步骤2：配置模型和MCP服务器</h3>
                    <div class="code-block">
                        <button class="copy-btn" onclick="copyCode(this)">复制</button>
                        <pre><code class="language-python"># 配置AI模型
models_to_add = [
    {
        "name": "gpt-4",
        "base_url": "https://api.openai.com/v1/",
        "api_key": "your-openai-api-key",
        "model": "gpt-4"
    },
    {
        "name": "gpt-3.5-turbo", 
        "base_url": "https://api.openai.com/v1/",
        "api_key": "your-openai-api-key",
        "model": "gpt-3.5-turbo"
    }
]

for model in models_to_add:
    try:
        result = mag.add_model(model)
        print(f"✅ 模型 {model['name']} 添加成功")
    except Exception as e:
        print(f"⚠️  模型 {model['name']} 可能已存在: {e}")

# 配置MCP服务器
mcp_config = {
    "mcpServers": {
        "tavily-mcp": {
            "command": "npx",
            "args": ["-y", "tavily-mcp@0.1.2"],
            "env": {
                "TAVILY_API_KEY": "your-tavily-api-key"  # 请替换为实际API密钥
            }
        },
        "fetch": {
            "autoApprove": ["fetch"],
            "timeout": 60,
            "command": "uvx",
            "args": ["mcp-server-fetch"],
            "transportType": "stdio"
        }
    }
}

# 更新MCP配置
result = mag.update_mcp_config(mcp_config)
print("✅ MCP配置更新完成")

# 连接所有MCP服务器
print("连接MCP服务器...")
result = mag.connect_mcp("all")
print(f"连接结果: {result.get('status', 'unknown')}")
</code></pre>
                    </div>

                    <h3>步骤3：创建研究工作流图</h3>
                    <div class="code-block">
                        <button class="copy-btn" onclick="copyCode(this)">复制</button>
                        <pre><code class="language-python"># 创建研究工作流图
research_graph = {
    "name": "research_workflow",
    "description": "完整的研究工作流：搜索 -> 分析 -> 报告",
    "nodes": [
        {
            "id": "search_node",
            "name": "信息搜索",
            "type": "agent",
            "model_name": "gpt-3.5-turbo",
            "system_prompt": """你是一个专业的信息搜索专家。
任务：根据用户的研究主题，使用搜索工具收集相关信息。
要求：
1. 理解用户的研究需求
2. 设计有效的搜索关键词
3. 收集多个角度的信息
4. 整理搜索结果""",
            "user_prompt": "研究主题：{input}\\n\\n请搜索相关信息，并整理搜索结果。",
            "mcp_servers": ["tavily-mcp"],
            "position": {"x": 100, "y": 100}
        },
        {
            "id": "analysis_node",
            "name": "信息分析",
            "type": "agent", 
            "model_name": "gpt-4",
            "system_prompt": """你是一个专业的数据分析师。
任务：分析前一步搜索到的信息，提取关键洞察。
要求：
1. 深入分析搜索结果
2. 识别重要趋势和模式
3. 提取关键数据和事实
4. 评估信息的可靠性
5. 总结主要发现""",
            "user_prompt": "基于以下搜索结果进行深度分析：\\n\\n{previous_output}\\n\\n请提供详细的分析报告。",
            "mcp_servers": [],
            "position": {"x": 300, "y": 100}
        },
        {
            "id": "report_node",
            "name": "报告生成",
            "type": "agent",
            "model_name": "gpt-4",
            "system_prompt": """你是一个专业的技术写作专家。
任务：基于分析结果生成结构化的研究报告。
要求：
1. 创建清晰的报告结构
2. 使用专业的写作风格
3. 包含执行摘要
4. 提供详细的分析内容
5. 给出结论和建议
6. 使用Markdown格式""",
            "user_prompt": "基于以下分析结果生成专业研究报告：\\n\\n{previous_output}\\n\\n请生成结构化的Markdown报告。",
            "mcp_servers": [],
            "position": {"x": 500, "y": 100}
        }
    ],
    "edges": [
        {"from": "search_node", "to": "analysis_node"},
        {"from": "analysis_node", "to": "report_node"}
    ],
    "version": "1.0"
}

# 保存图
result = mag.save_graph(research_graph)
if result.get("status") == "success":
    print("✅ 研究工作流图创建成功")
else:
    print(f"❌ 图创建失败: {result.get('message')}")
</code></pre>
                    </div>

                    <h3>步骤4：执行研究工作流</h3>
                    <div class="code-block">
                        <button class="copy-btn" onclick="copyCode(this)">复制</button>
                        <pre><code class="language-python"># 执行研究工作流
research_topic = "大语言模型在2024年的最新发展趋势"

print(f"开始研究：{research_topic}")
print("=" * 60)

start_time = time.time()

# 运行图
result = mag.run_graph(
    name="research_workflow",
    input_text=research_topic,
    parallel=False  # 顺序执行确保数据流正确
)

execution_time = time.time() - start_time

# 处理结果
if result.get("status") == "success":
    print("✅ 研究工作流执行成功")
    print(f"⏱️  执行时间: {execution_time:.1f} 秒")
    print(f"📋 会话ID: {result['conversation_id']}")
    
    # 显示最终报告
    print("\\n📄 研究报告:")
    print("=" * 60)
    print(result.get("output", ""))
    
    # 获取详细的会话信息
    conversation = mag.get_conversation(result['conversation_id'])
    
    # 检查是否有附件
    attachments = conversation.get('attachments', [])
    if attachments:
        print(f"\\n📎 生成的附件 ({len(attachments)} 个):")
        for att in attachments:
            print(f"   • {att['name']} ({att['type']}) - {att.get('size', 0)} 字节")
    
    # 显示各节点的执行结果
    if 'node_results' in conversation:
        print("\\n🔧 各节点执行摘要:")
        for node_id, node_result in conversation['node_results'].items():
            status = node_result.get('status', 'unknown')
            status_icon = '✅' if status == 'success' else '❌'
            print(f"   {status_icon} {node_id}: {status}")
            
            if node_result.get('output'):
                output_preview = node_result['output'][:100] + "..." if len(node_result['output']) > 100 else node_result['output']
                print(f"      预览: {output_preview}")

else:
    print(f"❌ 研究工作流执行失败")
    print(f"错误信息: {result.get('error', 'Unknown error')}")
</code></pre>
                    </div>

                    <h3>步骤5：结果分析和后续处理</h3>
                    <div class="code-block">
                        <button class="copy-btn" onclick="copyCode(this)">复制</button>
                        <pre><code class="language-python"># 分析和后续处理
def analyze_research_results(conversation_id):
    """分析研究结果"""
    conversation = mag.get_conversation(conversation_id)
    
    print("\\n📊 研究结果分析:")
    print("-" * 40)
    
    # 基本统计
    output = conversation.get('output', '')
    word_count = len(output.split())
    char_count = len(output)
    
    print(f"报告字数: {word_count:,}")
    print(f"字符数: {char_count:,}")
    
    # 节点执行分析
    node_results = conversation.get('node_results', {})
    for node_id, result in node_results.items():
        output_length = len(result.get('output', ''))
        print(f"{node_id} 输出长度: {output_length:,} 字符")
    
    # 保存报告到文件
    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    filename = f"research_report_{timestamp}.md"
    
    with open(filename, 'w', encoding='utf-8') as f:
        f.write(f"# 研究报告\\n\\n")
        f.write(f"**生成时间**: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\\n")
        f.write(f"**会话ID**: {conversation_id}\\n\\n")
        f.write(output)
    
    print(f"\\n💾 报告已保存为: {filename}")
    return filename

# 如果执行成功，分析结果
if result.get("status") == "success":
    report_file = analyze_research_results(result['conversation_id'])
    
    # 可选：导出图配置以便复用
    export_result = mag.export_graph("research_workflow")
    if export_result.get("status") == "success":
        print(f"📦 图配置已导出为: {export_result['file_path']}")

print("\\n🎉 完整研究工作流演示完成！")
</code></pre>
                    </div>
                </div>
            </section>

            <!-- 常见使用场景 -->
            <section class="section" id="use-cases">
                <h2><i class="fas fa-lightbulb"></i> 常见使用场景</h2>

                <div class="example-card">
                    <div class="example-header">
                        <div class="example-icon">
                            <i class="fas fa-search"></i>
                        </div>
                        <div class="example-title">智能搜索和信息收集</div>
                    </div>
                    
                    <p>创建智能搜索助手，能够理解用户意图，执行多源搜索，并整合结果。</p>
                    
                    <div class="code-block">
                        <button class="copy-btn" onclick="copyCode(this)">复制</button>
                        <pre><code class="language-python"># 智能搜索图示例
smart_search_graph = {
    "name": "smart_search",
    "description": "智能搜索和信息整合",
    "nodes": [
        {
            "id": "intent_analyzer",
            "name": "意图分析",
            "model_name": "gpt-4",
            "system_prompt": "分析用户搜索意图，生成最佳搜索策略",
            "user_prompt": "用户查询: {input}\\n请分析搜索意图并生成搜索关键词。",
            "mcp_servers": []
        },
        {
            "id": "multi_search",
            "name": "多源搜索", 
            "model_name": "gpt-3.5-turbo",
            "system_prompt": "执行多个搜索查询，收集全面信息",
            "user_prompt": "基于搜索策略执行搜索: {previous_output}",
            "mcp_servers": ["tavily-mcp", "fetch"]
        },
        {
            "id": "result_synthesizer",
            "name": "结果整合",
            "model_name": "gpt-4",
            "system_prompt": "整合多个搜索结果，提供综合答案",
            "user_prompt": "整合以下搜索结果: {previous_output}",
            "mcp_servers": []
        }
    ],
    "edges": [
        {"from": "intent_analyzer", "to": "multi_search"},
        {"from": "multi_search", "to": "result_synthesizer"}
    ]
}

# 保存并测试
mag.save_graph(smart_search_graph)
result = mag.run_graph("smart_search", "最新的AI芯片技术发展")
</code></pre>
                    </div>
                </div>

                <div class="example-card">
                    <div class="example-header">
                        <div class="example-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="example-title">数据分析和可视化</div>
                    </div>
                    
                    <p>构建数据分析流水线，从数据收集到清理、分析和可视化。</p>
                    
                    <div class="code-block">
                        <button class="copy-btn" onclick="copyCode(this)">复制</button>
                        <pre><code class="language-python"># 数据分析流水线
data_analysis_graph = {
    "name": "data_analysis_pipeline",
    "description": "数据收集、清理、分析和可视化",
    "nodes": [
        {
            "id": "data_collector",
            "name": "数据收集",
            "model_name": "gpt-3.5-turbo",
            "system_prompt": "收集指定主题的数据",
            "user_prompt": "收集关于 {input} 的数据",
            "mcp_servers": ["fetch", "tavily-mcp"]
        },
        {
            "id": "data_cleaner", 
            "name": "数据清理",
            "model_name": "gpt-4",
            "system_prompt": "清理和标准化数据格式",
            "user_prompt": "清理以下数据: {previous_output}",
            "mcp_servers": []
        },
        {
            "id": "data_analyzer",
            "name": "数据分析",
            "model_name": "gpt-4",
            "system_prompt": "执行统计分析和趋势识别",
            "user_prompt": "分析数据并识别模式: {previous_output}",
            "mcp_servers": []
        },
        {
            "id": "report_generator",
            "name": "报告生成",
            "model_name": "gpt-4", 
            "system_prompt": "生成包含图表的分析报告",
            "user_prompt": "生成分析报告: {previous_output}",
            "mcp_servers": []
        }
    ],
    "edges": [
        {"from": "data_collector", "to": "data_cleaner"},
        {"from": "data_cleaner", "to": "data_analyzer"},
        {"from": "data_analyzer", "to": "report_generator"}
    ]
}
</code></pre>
                    </div>
                </div>

                <div class="example-card">
                    <div class="example-header">
                        <div class="example-icon">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div class="example-title">内容创作助手</div>
                    </div>
                    
                    <p>创建多步骤内容创作流程，包括研究、大纲、写作和校对。</p>
                    
                    <div class="code-block">
                        <button class="copy-btn" onclick="copyCode(this)">复制</button>
                        <pre><code class="language-python"># 内容创作助手
content_creation_graph = {
    "name": "content_creator",
    "description": "完整的内容创作流程",
    "nodes": [
        {
            "id": "topic_researcher",
            "name": "主题研究",
            "model_name": "gpt-4",
            "system_prompt": "深入研究内容主题，收集相关信息",
            "user_prompt": "研究主题: {input}",
            "mcp_servers": ["tavily-mcp"]
        },
        {
            "id": "outline_creator",
            "name": "大纲制作",
            "model_name": "gpt-4",
            "system_prompt": "基于研究结果创建详细大纲",
            "user_prompt": "基于研究创建大纲: {previous_output}",
            "mcp_servers": []
        },
        {
            "id": "content_writer",
            "name": "内容写作",
            "model_name": "gpt-4",
            "system_prompt": "根据大纲撰写高质量内容",
            "user_prompt": "按照大纲撰写内容: {previous_output}",
            "mcp_servers": []
        },
        {
            "id": "content_editor",
            "name": "内容编辑",
            "model_name": "gpt-4",
            "system_prompt": "校对和优化内容质量",
            "user_prompt": "编辑和优化内容: {previous_output}",
            "mcp_servers": []
        }
    ],
    "edges": [
        {"from": "topic_researcher", "to": "outline_creator"},
        {"from": "outline_creator", "to": "content_writer"},
        {"from": "content_writer", "to": "content_editor"}
    ]
}

# 使用示例
mag.save_graph(content_creation_graph)
result = mag.run_graph("content_creator", "如何使用AI提高工作效率")
</code></pre>
                    </div>
                </div>
            </section>

            <!-- 最佳实践 -->
            <section class="section" id="best-practices">
                <h2><i class="fas fa-star"></i> 最佳实践</h2>

                <div class="example-card">
                    <div class="example-header">
                        <div class="example-icon">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                        <div class="example-title">安全和错误处理</div>
                    </div>

                    <div class="code-block">
                        <button class="copy-btn" onclick="copyCode(this)">复制</button>
                        <pre><code class="language-python">import mag
import os
import logging
from contextlib import contextmanager

# 配置日志
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

@contextmanager
def mag_session():
    """安全的MAG会话管理器"""
    try:
        # 启动服务
        if not mag.start():
            raise RuntimeError("无法启动MAG服务")
        logger.info("MAG服务已启动")
        yield
    except Exception as e:
        logger.error(f"MAG会话出错: {e}")
        raise
    finally:
        # 确保清理
        mag.shutdown()
        logger.info("MAG服务已关闭")

def safe_add_model_from_env(model_name, env_prefix):
    """从环境变量安全添加模型"""
    api_key = os.getenv(f"{env_prefix}_API_KEY")
    base_url = os.getenv(f"{env_prefix}_BASE_URL")
    model_id = os.getenv(f"{env_prefix}_MODEL", model_name)
    
    if not api_key:
        raise ValueError(f"环境变量 {env_prefix}_API_KEY 未设置")
    if not base_url:
        raise ValueError(f"环境变量 {env_prefix}_BASE_URL 未设置")
    
    model_config = {
        "name": model_name,
        "base_url": base_url,
        "api_key": api_key,
        "model": model_id
    }
    
    try:
        result = mag.add_model(model_config)
        if result.get("status") == "success":
            logger.info(f"模型 {model_name} 添加成功")
            return True
        else:
            logger.error(f"模型添加失败: {result.get('message')}")
            return False
    except Exception as e:
        logger.error(f"添加模型时出错: {e}")
        return False

def robust_graph_execution(graph_name, input_text, max_retries=3):
    """健壮的图执行函数"""
    for attempt in range(max_retries):
        try:
            logger.info(f"执行图 {graph_name} (尝试 {attempt + 1}/{max_retries})")
            result = mag.run_graph(graph_name, input_text)
            
            if result.get("status") == "success":
                logger.info("图执行成功")
                return result
            else:
                error_msg = result.get("error", "Unknown error")
                logger.warning(f"图执行失败: {error_msg}")
                
                if attempt < max_retries - 1:
                    logger.info("准备重试...")
                    time.sleep(2 ** attempt)  # 指数退避
                
        except Exception as e:
            logger.error(f"执行过程中出错: {e}")
            if attempt < max_retries - 1:
                time.sleep(2 ** attempt)
            else:
                raise
    
    raise RuntimeError(f"图执行失败，已达到最大重试次数 {max_retries}")

# 使用示例
with mag_session():
    # 安全地添加模型
    safe_add_model_from_env("gpt-4", "OPENAI")
    
    # 健壮地执行图
    result = robust_graph_execution("my_graph", "test input")
</code></pre>
                    </div>
                </div>

                <div class="example-card">
                    <div class="example-header">
                        <div class="example-icon">
                            <i class="fas fa-tachometer-alt"></i>
                        </div>
                        <div class="example-title">性能优化</div>
                    </div>

                    <div class="code-block">
                        <button class="copy-btn" onclick="copyCode(this)">复制</button>
                        <pre><code class="language-python"># 性能优化最佳实践

def optimize_graph_for_performance(graph_config):
    """优化图配置以提高性能"""
    optimized = graph_config.copy()
    
    # 1. 识别可并行执行的节点
    parallel_candidates = []
    for node in optimized["nodes"]:
        # 检查节点是否有入边
        has_dependencies = any(
            edge["to"] == node["id"] 
            for edge in optimized.get("edges", [])
        )
        if not has_dependencies:
            parallel_candidates.append(node["id"])
    
    print(f"可并行执行的节点: {parallel_candidates}")
    
    # 2. 选择合适的模型
    for node in optimized["nodes"]:
        # 对于简单任务使用更快的模型
        if "简单" in node.get("system_prompt", "").lower():
            if node["model_name"] == "gpt-4":
                node["model_name"] = "gpt-3.5-turbo"
                print(f"节点 {node['id']} 降级为gpt-3.5-turbo")
    
    # 3. 优化提示词长度
    for node in optimized["nodes"]:
        system_prompt = node.get("system_prompt", "")
        if len(system_prompt) > 1000:
            # 提示用户考虑简化提示词
            print(f"警告: 节点 {node['id']} 的系统提示词较长 ({len(system_prompt)} 字符)")
    
    return optimized

def monitor_execution_performance(graph_name, input_text):
    """监控图执行性能"""
    import time
    import psutil
    
    # 记录初始状态
    start_time = time.time()
    start_memory = psutil.Process().memory_info().rss / 1024 / 1024  # MB
    
    print(f"开始执行图: {graph_name}")
    print(f"初始内存使用: {start_memory:.1f} MB")
    
    # 执行图
    result = mag.run_graph(graph_name, input_text)
    
    # 记录结束状态
    end_time = time.time()
    end_memory = psutil.Process().memory_info().rss / 1024 / 1024  # MB
    
    execution_time = end_time - start_time
    memory_delta = end_memory - start_memory
    
    print(f"执行完成，用时: {execution_time:.2f} 秒")
    print(f"内存变化: {memory_delta:.1f} MB")
    
    # 分析结果
    if result.get("status") == "success":
        output_length = len(result.get("output", ""))
        print(f"输出长度: {output_length} 字符")
        print(f"处理效率: {output_length/execution_time:.1f} 字符/秒")
    
    return result, {
        "execution_time": execution_time,
        "memory_delta": memory_delta,
        "success": result.get("status") == "success"
    }

# 缓存机制
class GraphExecutionCache:
    """图执行结果缓存"""
    
    def __init__(self):
        self.cache = {}
    
    def get_cache_key(self, graph_name, input_text):
        """生成缓存键"""
        import hashlib
        key_string = f"{graph_name}:{input_text}"
        return hashlib.md5(key_string.encode()).hexdigest()
    
    def get(self, graph_name, input_text):
        """获取缓存结果"""
        key = self.get_cache_key(graph_name, input_text)
        return self.cache.get(key)
    
    def set(self, graph_name, input_text, result):
        """设置缓存结果"""
        key = self.get_cache_key(graph_name, input_text)
        self.cache[key] = result
        print(f"结果已缓存: {key[:8]}...")
    
    def clear(self):
        """清空缓存"""
        self.cache.clear()

# 使用缓存执行图
cache = GraphExecutionCache()

def cached_run_graph(graph_name, input_text):
    """带缓存的图执行"""
    # 检查缓存
    cached_result = cache.get(graph_name, input_text)
    if cached_result:
        print("✅ 使用缓存结果")
        return cached_result
    
    # 执行图
    print("🔄 执行新计算")
    result = mag.run_graph(graph_name, input_text)
    
    # 缓存结果
    if result.get("status") == "success":
        cache.set(graph_name, input_text, result)
    
    return result
</code></pre>
                    </div>
                </div>
            </section>

            <!-- 故障排除 -->
            <section class="section" id="troubleshooting">
                <h2><i class="fas fa-wrench"></i> 故障排除</h2>

                <div class="example-card">
                    <div class="example-header">
                        <div class="example-icon">
                            <i class="fas fa-bug"></i>
                        </div>
                        <div class="example-title">常见问题诊断和解决</div>
                    </div>

                    <div class="code-block">
                        <button class="copy-btn" onclick="copyCode(this)">复制</button>
                        <pre><code class="language-python"># 故障排除工具集

def diagnose_mag_system():
    """诊断MAG系统状态"""
    print("🔍 MAG系统诊断")
    print("=" * 50)
    
    # 1. 检查服务状态
    print("1. 服务状态检查:")
    is_running = mag.is_running()
    print(f"   服务运行状态: {'✅ 正常' if is_running else '❌ 未运行'}")
    
    if not is_running:
        print("   建议: 运行 mag.start() 启动服务")
        return
    
    # 2. 检查模型配置
    print("\\n2. 模型配置检查:")
    try:
        models = mag.list_models()
        print(f"   已配置模型数量: {len(models)}")
        
        if not models:
            print("   ⚠️  警告: 未配置任何模型")
            print("   建议: 使用 mag.add_model() 添加模型")
        else:
            for model in models:
                has_api_key = bool(model.get("api_key"))
                print(f"   • {model['name']}: {'✅' if has_api_key else '❌'} API密钥")
    except Exception as e:
        print(f"   ❌ 获取模型列表失败: {e}")
    
    # 3. 检查MCP服务器状态
    print("\\n3. MCP服务器状态检查:")
    try:
        mcp_status = mag.get_mcp_status()
        total_servers = len(mcp_status)
        connected_servers = sum(1 for status in mcp_status.values() 
                               if status.get("connected", False))
        
        print(f"   总服务器数: {total_servers}")
        print(f"   已连接服务器: {connected_servers}")
        
        if connected_servers < total_servers:
            print("   ⚠️  部分服务器未连接")
            print("   建议: 运行 mag.connect_mcp('all') 连接所有服务器")
            
            # 显示未连接的服务器
            for server_name, status in mcp_status.items():
                if not status.get("connected", False):
                    print(f"   • {server_name}: 未连接")
    except Exception as e:
        print(f"   ❌ 获取MCP状态失败: {e}")
    
    # 4. 检查图配置
    print("\\n4. 图配置检查:")
    try:
        graphs = mag.list_graphs()
        print(f"   可用图数量: {len(graphs)}")
        
        if graphs:
            for graph_name in graphs[:5]:  # 只显示前5个
                try:
                    graph_config = mag.get_graph(graph_name)
                    node_count = len(graph_config.get("nodes", []))
                    print(f"   • {graph_name}: {node_count} 个节点")
                except Exception as e:
                    print(f"   • {graph_name}: ❌ 配置错误 - {e}")
        else:
            print("   ℹ️  没有可用的图")
    except Exception as e:
        print(f"   ❌ 获取图列表失败: {e}")
    
    print("\\n✅ 诊断完成")

def fix_common_issues():
    """修复常见问题"""
    print("🔧 自动修复常见问题")
    print("=" * 50)
    
    # 1. 尝试启动服务
    if not mag.is_running():
        print("1. 尝试启动MAG服务...")
        if mag.start():
            print("   ✅ 服务启动成功")
        else:
            print("   ❌ 服务启动失败")
            print("   建议: 检查端口占用或权限问题")
            return
    
    # 2. 尝试连接MCP服务器
    print("\\n2. 尝试连接MCP服务器...")
    try:
        result = mag.connect_mcp("all")
        if result.get("status") in ["success", "partial_success"]:
            print("   ✅ MCP服务器连接成功")
        else:
            print(f"   ⚠️  连接结果: {result}")
    except Exception as e:
        print(f"   ❌ 连接失败: {e}")
    
    # 3. 清理无效会话
    print("\\n3. 清理无效会话...")
    try:
        conversations = mag.list_conversations()
        invalid_conversations = []
        
        for conv_id in conversations:
            try:
                mag.get_conversation(conv_id)
            except Exception:
                invalid_conversations.append(conv_id)
        
        if invalid_conversations:
            print(f"   发现 {len(invalid_conversations)} 个无效会话")
            for conv_id in invalid_conversations:
                try:
                    mag.delete_conversation(conv_id)
                    print(f"   ✅ 已删除: {conv_id}")
                except Exception as e:
                    print(f"   ❌ 删除失败: {conv_id} - {e}")
        else:
            print("   ✅ 没有无效会话")
    except Exception as e:
        print(f"   ❌ 清理过程出错: {e}")
    
    print("\\n✅ 修复完成")

def test_basic_functionality():
    """测试基本功能"""
    print("🧪 基本功能测试")
    print("=" * 50)
    
    tests = [
        ("服务状态", lambda: mag.is_running()),
        ("获取模型列表", lambda: len(mag.list_models()) >= 0),
        ("获取图列表", lambda: len(mag.list_graphs()) >= 0),
        ("获取MCP状态", lambda: isinstance(mag.get_mcp_status(), dict)),
        ("获取会话列表", lambda: len(mag.list_conversations()) >= 0),
    ]
    
    passed = 0
    total = len(tests)
    
    for test_name, test_func in tests:
        try:
            result = test_func()
            if result:
                print(f"   ✅ {test_name}: 通过")
                passed += 1
            else:
                print(f"   ❌ {test_name}: 失败")
        except Exception as e:
            print(f"   ❌ {test_name}: 出错 - {e}")
    
    print(f"\\n📊 测试结果: {passed}/{total} 通过")
    
    if passed == total:
        print("🎉 所有基本功能正常!")
    else:
        print("⚠️  部分功能异常，请检查配置")

# 使用诊断工具
if __name__ == "__main__":
    diagnose_mag_system()
    fix_common_issues() 
    test_basic_functionality()
</code></pre>
                    </div>
                </div>
            </section>

            <!-- 高级用法 -->
            <section class="section" id="advanced-usage">
                <h2><i class="fas fa-rocket"></i> 高级用法</h2>

                <div class="example-card">
                    <div class="example-header">
                        <div class="example-icon">
                            <i class="fas fa-layer-group"></i>
                        </div>
                        <div class="example-title">图嵌套和组合模式</div>
                    </div>

                    <div class="code-block">
                        <button class="copy-btn" onclick="copyCode(this)">复制</button>
                        <pre><code class="language-python"># 高级图组合模式

class GraphOrchestrator:
    """图编排器 - 管理复杂的图组合和嵌套"""
    
    def __init__(self):
        self.execution_history = []
        self.shared_context = {}
    
    def create_composite_workflow(self, workflow_name, sub_graphs):
        """创建复合工作流"""
        print(f"创建复合工作流: {workflow_name}")
        
        # 创建主控制图
        main_graph = {
            "name": workflow_name,
            "description": f"复合工作流包含 {len(sub_graphs)} 个子图",
            "nodes": [],
            "edges": [],
            "version": "1.0"
        }
        
        # 为每个子图创建控制节点
        for i, (sub_graph_name, config) in enumerate(sub_graphs.items()):
            node_id = f"sub_graph_{i}_{sub_graph_name}"
            
            # 创建子图执行节点
            node = {
                "id": node_id,
                "name": f"执行 {sub_graph_name}",
                "type": "agent",
                "model_name": config.get("model", "gpt-4"),
                "system_prompt": f"""你是子图 {sub_graph_name} 的执行控制器。
任务: 根据输入和上下文执行子图，并整理输出结果。
要求: 确保数据正确传递给下一个子图。""",
                "user_prompt": config.get("prompt_template", "执行子图: {input}"),
                "mcp_servers": config.get("mcp_servers", []),
                "position": {"x": 200 * i, "y": 100},
                "metadata": {
                    "sub_graph": sub_graph_name,
                    "execution_order": i
                }
            }
            
            main_graph["nodes"].append(node)
            
            # 创建执行链
            if i > 0:
                prev_node = f"sub_graph_{i-1}_{list(sub_graphs.keys())[i-1]}"
                main_graph["edges"].append({
                    "from": prev_node,
                    "to": node_id
                })
        
        return main_graph
    
    def execute_with_checkpoints(self, graph_name, input_text, checkpoint_interval=2):
        """带检查点的图执行"""
        print(f"开始执行图 {graph_name}，检查点间隔: {checkpoint_interval}")
        
        # 获取图配置
        graph_config = mag.get_graph(graph_name)
        nodes = graph_config.get("nodes", [])
        
        results = {}
        checkpoint_data = {}
        
        for i, node in enumerate(nodes):
            node_id = node["id"]
            print(f"执行节点: {node_id} ({i+1}/{len(nodes)})")
            
            try:
                # 这里简化为直接运行整个图，实际实现需要节点级控制
                if i == 0:
                    # 第一个节点，使用原始输入
                    current_input = input_text
                else:
                    # 后续节点使用前一个节点的输出
                    prev_result = results.get(list(results.keys())[-1], {})
                    current_input = prev_result.get("output", "")
                
                # 模拟节点执行（实际需要更复杂的实现）
                node_result = {
                    "status": "success",
                    "output": f"节点 {node_id} 的输出基于: {current_input[:100]}...",
                    "execution_time": time.time()
                }
                
                results[node_id] = node_result
                
                # 创建检查点
                if (i + 1) % checkpoint_interval == 0:
                    checkpoint_data[f"checkpoint_{i+1}"] = {
                        "completed_nodes": list(results.keys()),
                        "timestamp": time.time(),
                        "last_output": node_result["output"]
                    }
                    print(f"✅ 检查点已创建: checkpoint_{i+1}")
                
            except Exception as e:
                print(f"❌ 节点 {node_id} 执行失败: {e}")
                # 可以选择回滚到最近的检查点
                return self.rollback_to_checkpoint(checkpoint_data, results)
        
        return {
            "status": "success",
            "results": results,
            "checkpoints": checkpoint_data
        }
    
    def rollback_to_checkpoint(self, checkpoint_data, current_results):
        """回滚到最近的检查点"""
        if not checkpoint_data:
            print("❌ 没有可用的检查点")
            return {"status": "failed", "error": "No checkpoints available"}
        
        latest_checkpoint = max(checkpoint_data.keys())
        checkpoint = checkpoint_data[latest_checkpoint]
        
        print(f"🔄 回滚到检查点: {latest_checkpoint}")
        print(f"   完成的节点: {checkpoint['completed_nodes']}")
        
        return {
            "status": "rollback",
            "checkpoint": latest_checkpoint,
            "completed_nodes": checkpoint["completed_nodes"],
            "last_output": checkpoint["last_output"]
        }

# 创建复合工作流示例
orchestrator = GraphOrchestrator()

# 定义子图配置
sub_graphs = {
    "data_collection": {
        "model": "gpt-3.5-turbo",
        "mcp_servers": ["fetch", "tavily-mcp"],
        "prompt_template": "收集数据: {input}"
    },
    "data_analysis": {
        "model": "gpt-4", 
        "mcp_servers": [],
        "prompt_template": "分析数据: {previous_output}"
    },
    "report_generation": {
        "model": "gpt-4",
        "mcp_servers": [],
        "prompt_template": "生成报告: {previous_output}"
    }
}

# 创建复合工作流
composite_graph = orchestrator.create_composite_workflow(
    "advanced_research_pipeline", 
    sub_graphs
)

# 保存并执行
mag.save_graph(composite_graph)
result = orchestrator.execute_with_checkpoints(
    "advanced_research_pipeline",
    "AI在医疗领域的应用",
    checkpoint_interval=1
)
</code></pre>
                    </div>
                </div>

                <div class="example-card">
                    <div class="example-header">
                        <div class="example-icon">
                            <i class="fas fa-cogs"></i>
                        </div>
                        <div class="example-title">动态图生成和自适应执行</div>
                    </div>

                    <div class="code-block">
                        <button class="copy-btn" onclick="copyCode(this)">复制</button>
                        <pre><code class="language-python"># 动态图生成系统

class DynamicGraphBuilder:
    """动态图构建器"""
    
    def __init__(self):
        self.template_library = {}
        self.load_templates()
    
    def load_templates(self):
        """加载图模板库"""
        self.template_library = {
            "search_analyze": {
                "description": "搜索并分析信息",
                "nodes": ["searcher", "analyzer"],
                "complexity": "simple"
            },
            "research_report": {
                "description": "完整研究流程",
                "nodes": ["searcher", "analyzer", "synthesizer", "reporter"],
                "complexity": "complex"
            },
            "content_creation": {
                "description": "内容创作流程",
                "nodes": ["researcher", "outliner", "writer", "editor"],
                "complexity": "complex"
            }
        }
    
    def analyze_user_intent(self, user_request):
        """分析用户意图并推荐图模板"""
        # 简化的意图分析
        intent_keywords = {
            "search": ["搜索", "查找", "找", "search", "find"],
            "analyze": ["分析", "research", "研究", "analyze"],
            "create": ["创建", "写", "生成", "create", "generate"],
            "report": ["报告", "总结", "report", "summary"]
        }
        
        detected_intents = []
        request_lower = user_request.lower()
        
        for intent, keywords in intent_keywords.items():
            if any(keyword in request_lower for keyword in keywords):
                detected_intents.append(intent)
        
        # 推荐模板
        if "search" in detected_intents and "analyze" in detected_intents:
            if "report" in detected_intents:
                return "research_report"
            else:
                return "search_analyze"
        elif "create" in detected_intents:
            return "content_creation"
        else:
            return "search_analyze"  # 默认
    
    def generate_graph_from_intent(self, user_request, template_name=None):
        """根据用户意图动态生成图"""
        if not template_name:
            template_name = self.analyze_user_intent(user_request)
        
        template = self.template_library.get(template_name)
        if not template:
            raise ValueError(f"未找到模板: {template_name}")
        
        print(f"根据意图生成图，使用模板: {template_name}")
        
        # 生成图配置
        graph_name = f"dynamic_{template_name}_{int(time.time())}"
        
        graph_config = {
            "name": graph_name,
            "description": f"动态生成的图: {template['description']}",
            "nodes": [],
            "edges": [],
            "version": "1.0",
            "metadata": {
                "generated": True,
                "template": template_name,
                "user_request": user_request
            }
        }
        
        # 根据模板创建节点
        node_configs = self.get_node_configs_for_template(template_name)
        
        for i, (node_type, config) in enumerate(node_configs.items()):
            node = {
                "id": f"{node_type}_{i}",
                "name": config["name"],
                "type": "agent",
                "model_name": config["model"],
                "system_prompt": config["system_prompt"],
                "user_prompt": config["user_prompt"],
                "mcp_servers": config.get("mcp_servers", []),
                "position": {"x": 200 * i, "y": 100}
            }
            graph_config["nodes"].append(node)
            
            # 创建连接
            if i > 0:
                prev_node_id = f"{list(node_configs.keys())[i-1]}_{i-1}"
                graph_config["edges"].append({
                    "from": prev_node_id,
                    "to": node["id"]
                })
        
        return graph_config
    
    def get_node_configs_for_template(self, template_name):
        """获取模板的节点配置"""
        configs = {
            "search_analyze": {
                "searcher": {
                    "name": "信息搜索",
                    "model": "gpt-3.5-turbo",
                    "system_prompt": "你是信息搜索专家，负责收集相关信息。",
                    "user_prompt": "搜索: {input}",
                    "mcp_servers": ["tavily-mcp"]
                },
                "analyzer": {
                    "name": "信息分析",
                    "model": "gpt-4",
                    "system_prompt": "你是数据分析专家，负责分析搜索结果。",
                    "user_prompt": "分析: {previous_output}",
                    "mcp_servers": []
                }
            },
            "research_report": {
                "searcher": {
                    "name": "信息搜索",
                    "model": "gpt-3.5-turbo",
                    "system_prompt": "搜索相关信息",
                    "user_prompt": "搜索: {input}",
                    "mcp_servers": ["tavily-mcp"]
                },
                "analyzer": {
                    "name": "深度分析",
                    "model": "gpt-4",
                    "system_prompt": "深度分析搜索结果",
                    "user_prompt": "分析: {previous_output}",
                    "mcp_servers": []
                },
                "synthesizer": {
                    "name": "信息综合",
                    "model": "gpt-4",
                    "system_prompt": "综合分析结果",
                    "user_prompt": "综合: {previous_output}",
                    "mcp_servers": []
                },
                "reporter": {
                    "name": "报告生成",
                    "model": "gpt-4",
                    "system_prompt": "生成专业报告",
                    "user_prompt": "生成报告: {previous_output}",
                    "mcp_servers": []
                }
            }
        }
        
        return configs.get(template_name, {})
    
    def adaptive_execution(self, graph_name, input_text):
        """自适应执行 - 根据中间结果调整后续节点"""
        print(f"开始自适应执行: {graph_name}")
        
        # 获取图配置
        graph_config = mag.get_graph(graph_name)
        
        # 执行第一个节点
        result = mag.run_graph(graph_name, input_text)
        
        if result.get("status") != "success":
            return result
        
        # 分析中间结果，决定是否需要调整
        output = result.get("output", "")
        
        # 简单的自适应逻辑
        if len(output) < 500:
            print("⚠️  输出较短，可能需要更多信息")
            # 可以选择增加搜索节点或修改提示词
        elif "错误" in output or "失败" in output:
            print("⚠️  检测到执行问题，建议回滚")
        
        return result

# 使用动态图生成器
builder = DynamicGraphBuilder()

# 用户请求示例
user_requests = [
    "我想搜索并分析人工智能的最新发展",
    "帮我研究区块链技术并生成一份详细报告",
    "创建一篇关于可持续能源的文章"
]

for request in user_requests:
    print(f"\\n处理用户请求: {request}")
    
    # 生成动态图
    graph_config = builder.generate_graph_from_intent(request)
    print(f"生成图: {graph_config['name']}")
    
    # 保存并执行
    mag.save_graph(graph_config)
    result = builder.adaptive_execution(graph_config['name'], request)
    
    if result.get("status") == "success":
        print("✅ 动态图执行成功")
    else:
        print(f"❌ 执行失败: {result.get('error')}")
</code></pre>
                    </div>
                </div>
            </section>

            <!-- 总结 -->
            <section class="section">
                <div class="success">
                    <h4><i class="fas fa-graduation-cap"></i> 学习完成</h4>
                    <p>恭喜您完成了MAG SDK的完整教程！您现在已经掌握了从基础使用到高级技巧的全部内容。建议您根据实际需求选择合适的模式开始构建您的智能体系统。</p>
                </div>

                <div class="note">
                    <h4><i class="fas fa-lightbulb"></i> 下一步建议</h4>
                    <p>• 从简单的单节点图开始实践<br>
                    • 逐步尝试多节点工作流<br>
                    • 探索MCP服务器的丰富功能<br>
                    • 参与社区讨论和贡献<br>
                    • 关注项目更新和新功能</p>
                </div>
            </section>
        </main>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script>
        // 复制代码功能
        function copyCode(button) {
            const code = button.nextElementSibling.textContent;
            navigator.clipboard.writeText(code).then(() => {
                const originalText = button.textContent;
                button.textContent = '已复制!';
                button.style.background = '#10b981';
                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.background = '#4b5563';
                }, 2000);
            });
        }

        // 代码高亮
        Prism.highlightAll();
    </script>
</body>
</html>